
# Map Unit Spatial Summary Report

This report summarizes the geographic setting of a list of MUSYM within a shapefile. It is intented to be used to compare and contrast map units, and suggest possible Low, RV, and High values for soil components. 

```{r load-data, echo=FALSE, results='hide', message=FALSE}
shp <- "201511IND015_Cslm,WLwlnd,2t6psl,e_QA"

dir <- "M:/geodata/project_data/"
geodatabase <- "RTSD_R11-IND_FY16.gdb"
office <- "11IND"

# Defaults
samplePercent <- 20
p <- c(0, 0.25, 0.5, 0.75, 1)

pd <- paste0(dir, office, "/")
rd <- paste0(dir, "11REGION/")
dsn <- paste0(pd, "cache/", shp, ".shp")
cache <- paste0(dsn, "_", samplePercent, ".Rdata")
```


```{r LoadPackages, include=F}
library(knitr)
library(lattice)
library(circular)
library(maps)
library(sp)
library(raster)
library(rgdal)
library(rgeos)
library(plyr)
library(ggplot2)
library(reshape2)

source("report_functions.R")
```
```{r map unit summary function, echo=FALSE}
## local functions
if (!file.exists(cache)){
  sapolygon <- readOGR(dsn = paste0(pd, geodatabase), layer = "SAPOLYGON", encoding = "OpenFileGDB")
  mupolygon <- readOGR(dsn = dsn, layer = shp, encoding = "ESRI Shapefile")
  mupolygon@data$Acres <- mupolygon@data[, grepl("_area", tolower(names(mupolygon)))] * 0.000247105
  mupolygon@data$Circularity <- mupolygon@data[, grepl("_leng", tolower(names(mupolygon)))] / (2 * sqrt(mupolygon@data[, grepl("_area", tolower(names(mupolygon)))] / pi) * pi)
  n <- ceiling(sum(mupolygon@data[, grepl("_area", tolower(names(mupolygon)))]) / 900 * samplePercent / 100)
  
  # Sample soil map unit
  mupolygon.s <- spsample(mupolygon, n = n, "stratified")
  geodata <- raster_extract(mupolygon.s)
  mapunit.df <- cbind(mupolygon.s, over(mupolygon.s, mupolygon))
  data <- cbind(mapunit.df[c("AREASYMBOL", "MUSYM")], geodata)
  
  mlra <- readOGR(dsn = "M:/geodata/project_data/11REGION/mlra_a_r11.shp", layer = "mlra_a_r11", encoding = "ESRI Shapefile")
  mlra_i <- over(mupolygon.s, mlra)
  mlra_acres <- ddply(mlra_i, .(MLRARSYM), summarize, mlra_percent = sum(length(OBJECTID)))
  mlra_acres <- transform(mlra_acres, mlra_percent = round(mlra_percent / sum(mlra_percent) * 100, 0))

  data.l <- list(data = data, mupolygon = mupolygon, sapolygon = sapolygon, mlra_acres = mlra_acres)
  save(data.l, file = cache)
} else load(file = cache) #load cache file


data <- data.l$data
mupolygon <- data.l$mupolygon
sapolygon <- data.l$sapolygon
mlra_acres <- data.l$mlra_acres


data$SSA_MUSYM <- as.character(paste(data$AREASYMBOL, data$MUSYM))
data2 <- data
data2$SSA_MUSYM <- "*mlra_mapnit"
data <- rbind(data2, data)
```


### Shapefile Name
```{r project name, echo=FALSE}
shp
```


### Variables

```{r variables, echo=FALSE}
a <- c("elev", "slope", "aspect", "valley", "wetness", "relief", "ppt", "temp", "ffp", "lulc")
m <- c("elevation", "slope gradient", "slope aspect", "multiresolution valley bottom index", "topographic Wetness index", "height above channel", "annual precipitation", "annual air temperature", "frost free period", "land use and land cover")
u <- c("meters", "percent", "degrees", "unitless", "unitless", "meters", "millimeters", "degrees Celsius", "days", "landcover class (e.g. Wood Wetlands)")
s <- c("30-meter USGS National Elevation Dataset (NED)", "10-meter NED", "10-meter NED", "30-meter NED", "30-meter NED", "30-meter NED", "800-meter 30-year normals (1981-2010) from PRISM Climate Dataset", "800-meter 30-year normals (1981-2010) from PRISM Climate Dataset", "1000-meter 30-year normals (1961-1990) from USFS RMRS", "2011 National Land Cover Dataset (NLCD)")

variables <- data.frame(Abbreviation = a, Measures = m, Unit = u, Source = s)

kable(variables)
```


## Map of soil polygons
Don't be concerned if the soil map units don't line up with the counties. The county layer being used is an internal R layer that is highly generalized.

```{r plot soil map units, echo=FALSE}
temp <- spTransform(mupolygon, CRS("+init=epsg:4326"))
plot(temp)
map("county", add=T)
map("state",lwd=3,add=T)
map.axes()
```

## Soil polygon metrics
Five number summary (min, 25th, median, 75th, max)(percentiles) and contingency table (counts)(n) 
Circularity is an estimate of SHAPE complexity (Hole and Campbell, 1975), computed as a ratio of mupolygon length / mupolygon circumference. The SHAPE complexity of a perfect circle would equal 1.

```{r soil polygon metrics, echo=FALSE, results='asis'}
pol <- data.frame(mupolygon)
pol$SSA_MUSYM <- as.character(paste(pol$AREASYMBOL, pol$MUSYM))
pol2 <- pol
pol2$SSA_MUSYM <- "*mlra_mapnit"
pol <- rbind(pol2, pol)

pol.lo1 <- melt(pol, id.vars="SSA_MUSYM", measure.vars=c("Acres", "Circularity"))
pol.lo2 <- melt(pol, id.vars="SSA_MUSYM", measure.vars=c("Acres"))
pol.5n1 <- ddply(pol.lo2, .(SSA_MUSYM, variable), .fun=sum5n2)
pol.5n2 <- ddply(pol, .(SSA_MUSYM), summarize, nArces=round(sum(Acres), 0), nPolygons=length(MUSYM))
pol.5n <- join(pol.5n1, pol.5n2, by = "SSA_MUSYM")

kable(pol.5n, digits = 0, align = "c", caption = "Summary of MUSYM by AREASYMBOL")

kable(mlra_acres, digits = 0, align = "c", caption = "Summary of Acres by MLRA")

# pol.lo1$SSA_MUSYM <- as.factor(pol.lo1$SSA_MUSYM)
pol.lo1$SSA_MUSYM <- factor(pol.lo1$SSA_MUSYM, levels = rev(sort(unique(pol.lo1$SSA_MUSYM))))
                                                          
bwplot(SSA_MUSYM ~ value | variable, data = pol.lo1, scales = list(x="free"), main = "Boxplots of polygon metrics", as.table = TRUE)

# qplot(SSA_MUSYM, value, data = pol.lo1, geom = "boxplot", main = "Boxplots of polygon metrics") + facet_wrap(~variable, scales = "free") + theme(axis.text.x = element_text(angle=45, hjust = 1, vjust = 1))
```

## Contingency tables (percent) 

```{r percentage by musym, echo=FALSE, results='asis'}
## Create descriptive and graphical summary of map unit
kable(prop.table(xtabs(~ SSA_MUSYM + slope_classes, data = data), margin = 1) * 100, align = "c", digits=0, caption="Slope classes")
kable(prop.table(xtabs(~ SSA_MUSYM + aspect_classes, data = data), margin = 1) * 100, align = "c", digits = 0, caption = "Aspect classes")
kable(prop.table(xtabs(~ SSA_MUSYM + valley_classes, data = data), margin = 1) * 100, align = "c", digits = 0, caption = "Upland vs. lowland")

lulc_t <- addmargins(prop.table(xtabs(~ SSA_MUSYM + lulc_classes, data = data), margin = 1)) * 100

idx <- pindex(lulc_t, 10)

for (i in unique(idx)){
  print(kable(lulc_t[, c(idx == i)], digits = 0, align = "c", caption = "Landuse and Landcover"))
  }

```

## Quantile breaks
Five number summary (min, 25th, median, 75th, max)(percentiles) and number of random samples (n)

```{r quantiles by musym, echo=FALSE, results="asis", warning=FALSE, fig.height=10}
data.lo <- melt(data, id.vars="SSA_MUSYM", measure.vars = c("elev", "slope", "valley", "wetness", "relief", "ppt", "temp", "ffp"))
data.5n <- ddply(data.lo, .(variable, SSA_MUSYM), .fun = sum5n2)
data.c <- dcast(data.5n, SSA_MUSYM ~ variable, value.var = 'range')
data.n <- ddply(data, .(SSA_MUSYM), .drop=T, summarize, n = length(SSA_MUSYM))

aspect.lo <- melt(data, id.vars="SSA_MUSYM", measure.vars = c("aspect"))
aspect.lo$value <- circular(aspect.lo$value, template = "geographic", units="degrees", modulo="2pi")
aspect.5n <- ddply(aspect.lo, .(variable, SSA_MUSYM), .fun = sum5n2)
aspect.c <- dcast(aspect.5n, SSA_MUSYM ~ variable, value.var = 'range')

kable(cbind(data.c[c(1:6)], data.n["n"]), align = "c")
kable(cbind(data.c[c(1, 7:9)], aspect.c["aspect"], data.n["n"]), align = "c")

data.lo$SSA_MUSYM <- factor(data.lo$SSA_MUSYM, levels = rev(sort(unique(data.lo$SSA_MUSYM))))

bwplot(SSA_MUSYM ~ value|variable, data=data.lo, scales=list(x="free"), main = "Boxplots of map unit properties", as.table = TRUE, layout = c(2, 4))

# qplot(SSA_MUSYM, value, data = data.lo, geom = "boxplot", main = "Boxplots of map unit properties") + facet_wrap(~variable, scales = "free", ncol = 2) + theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1))
```
