# Lab pedon report
```{r enter soil series name}
# Set soil series
series <- "Rossmoyne"
```

```{r load packages, include=FALSE}
# load libraries
library(aqp)
library(soilDB)
library(reshape)
library(plyr)
library(lattice)
library(maps)
library(xtable)
library(RODBC)
```

```{r fetch and format, load-data, echo=FALSE, warning=FALSE}
# source custom R functions
source(paste0("./genhz_rules/", series, "_rules.R"))

p <- c(0, 0.10, 0.5, 0.90, 1)

# load NASIS data
l <- fetchNASISLabData()
lh <- horizons(l)
lp <- site(l)
f <- fetchNASIS()
h <- horizons(f)
s <- site(f)

names(lh) <- unlist(strsplit(names(lh), "measured"))

for(i in seq(nrow(lh))){
  if(is.na(lh$hzname[i])) {lh$hzname[i] <-lh$hznameoriginal[i]}
}
lh$hzname[is.na(lh$hzname)] <- "NA"
lh$genhz <- generalize.hz(lh$hzname, ghr[[series]]$n, ghr[[series]]$p)

h$hzname[is.na(h$hzname)] <- "NA"
h$genhz <- generalize.hz(h$hzname, ghr[[series]]$n, ghr[[series]]$p)

naReplace <- function(x){
  l <- list()
  for(i in seq(names(x))){
    if(class(x[,i])=="character") {l[[i]] <- replace(x[,i], is.na(x[,i]), "NA")} else(l[[i]] <-  x[,i])
  }
  l <- data.frame(l, stringsAsFactors=FALSE)
  names(l) <- names(x)
  return(l)
}

h <- naReplace(h)

# Function
conditional.l.rv.h.summary <- function(x) {
  variable <- unique(x$variable)
  precision.table <- c(1, 1, 1, 1)
  precision.vars <- c('ph1to1h2o', 'ph01mcacl2', 'phoxidized', 'ph2osoluble')
	v <- na.omit(x$value) # extract column, from long-formatted input data
  precision <- if(variable %in% precision.vars) precision.table[match(variable, precision.vars)] else 0
  ci <- quantile(v, na.rm=TRUE, probs=p) 
  d <- data.frame(min=ci[1], low=ci[2], rv=ci[3], high=ci[4], max=ci[5], stringsAsFactors=FALSE) # combine into DF
  precision <- if(variable %in% precision.vars) precision.table[match(variable, precision.vars)] else 0
  d$range <- with(d, paste("(", paste(round(c(min, low, rv, high, max), precision), collapse=', '), ")", sep="")) # add 'range' column for pretty-printing
  return(d[6])
}
```
## Plot of all pedons in selected set
Pedons that do not have their Std_Latitude and Std_Longitude columns populated in the NASIS Site table are currently not ploted on the map.
```{r plot of pedons and locations, echo=FALSE}
if(dim(s)[1] != 0) {
  s.sub <- s[complete.cases(s[, c('x_std', 'y_std')]),]
  coordinates(s.sub) <- ~x_std+y_std
  plot(s.sub, pch=16)
  map("county", lwd=0.5, add=T)
  map("state",lwd=1,add=T)
  map.axes()
  } else("no coordinates")
```

## Soil profile plots (depth, color, horizonation, and user pedon id)
```{r Soil plots, echo=FALSE}
plot(l, label="labpeiid")
```

# Summary of NCSS Pedon Lab Data
```{r format site data, echo=FALSE, results='asis'}
# Site information
print(xtable(subset(s, select=c("pedon_id", "taxonname", "tax_subgroup", "part_size_class", "pedon_type", "describer"))), type="html")

# Summarize site data
lp.sub <- subset(lp, select=c("noncarbclaywtavg", "claytotwtavg", "le0to100", "wf0175wtavgpsc", "volfractgt2wtavg", "cec7clayratiowtavg"))
lp.m <- melt(lp.sub, measure.vars=c("noncarbclaywtavg", "claytotwtavg", "le0to100", "wf0175wtavgpsc", "volfractgt2wtavg", "cec7clayratiowtavg"))
lp.cs <- ddply(lp.m, .(variable), .fun=conditional.l.rv.h.summary)
```


## Range in characteristics of NCSS Pedon Lab Data
Five number summary (min, 25th, median, 75th, max)(percentiles)
```{r, echo=FALSE, results='asis'}
print(xtable(cast(lp.cs, ~variable, value='range')), type="html")
```

## Box plots of NCSS Pedon Lab Data
Graphical five number summary (outliers, 5th, 25th, median, 75th, 95th, outliers)
```{r bwplot for rf, echo=FALSE}
bwplot(variable ~ value, data=lp.m, scales=list(x="free"), xlab="percent")          
```


# Summary of NCSS Layer Lab Data
```{r, echo=FALSE, results='asis'}
# Summarize numeric variables by generic horizon
```{r, echo=FALSE, results='asis'}
lh.num <- lh[, c(12:(ncol(lh)-3), ncol(lh))]
lh.num <- Filter(function(x)!all(is.na(x)), lh.num)
lh.m <- melt(lh.num, id.vars="genhz", measure.vars=names(lh.num)[c(1:(ncol(lh.num)-1))])
lh.cs <- ddply(lh.m, .(variable, genhz), .fun=conditional.l.rv.h.summary)
```


## Horizon designations by generic horizon
Contingency table (counts) 

```{r, echo=FALSE, results='asis'}
print(xtable(addmargins(table(lh$genhz, lh$hzname)), digits=0), type="html") 
```


## Range in characteristics for generic horizons 
Five number summary (min, 25th, median, 75th, max)(percentiles)

```{r, echo=FALSE}
cast(lh.cs, genhz~variable, value='range')
```


## Box plots of numeric variables by generic horizon
Graphical five number summary (outliers, 5th, 25th, median, 75th, 95th, outliers)

```{r, echo=FALSE}
bwplot(factor(genhz, levels=levels(lh$genhz)[length(levels(lh$genhz)):1]) ~ value|variable, data=rbind(lh.m), scales=list(x="free"))          
```


## Texture by generic horizon
Contigency table (counts) 

```{r, echo=FALSE, results='asis'}
print(xtable(addmargins(table(lh$genhz, lh$lab_texcl)), digits=0), type="html")
```


## Stratified flag by generic horizon
Contingency table (counts) 

```{r, echo=FALSE, results='asis'}
print(xtable(addmargins(table(lh$genhz, lh$stratextsflag)), digits=0), type="html") 
```


## Depths and thickness of generic horizons
Five number summary (min, 25th, median, 75th, max)(percentiles)

```{r, echo=FALSE, results='asis'}
thk <- ddply(lh, .(labpeiid, genhz), summarize, thickness=sum(hzdepb-hzdept))
thk.m <- melt(thk, id.vars="genhz", measure.vars="thickness")

lh.m2 <- melt(lh, id.vars="genhz", measure.vars=c("hzdept", "hzdepb"))

lp.m <- melt(lp, id.vars="labpeiid", measure.vars=c("psctopdepth", "pscbotdepth"))
lp.thk <- ddply(lp, .(labpeiid), summarize, thickness=sum(pscbotdepth-psctopdepth))
lp.thk.m <- melt(lp.thk, id.vars="labpeiid", measure.vars="thickness")

lh.thk.m <- rbind(lh.m2, thk.m)
lp.thk.m <- rbind(lp.m, lp.thk.m)

lh.thk.cs <- ddply(lh.thk.m, .(variable, genhz), .fun=conditional.l.rv.h.summary)
lp.thk.cs <- ddply(lp.thk.m, .(variable), .fun=conditional.l.rv.h.summary)
print(xtable(cast(lh.thk.cs, genhz ~ variable, value='range'), digits=0), type="html")
print(xtable(lp.thk.cs, digits=0), type="html")
```


## Boxplot of generic horizon thicknesses
Graphical five number summary (outliers, 5th, 25th, median, 75th, 95th, outliers)(percentiles)

```{r, echo=FALSE}
bwplot(factor(genhz, levels=levels(lh$genhz)[length(levels(lh$genhz)):1]) ~ value|variable, data=lh.thk.m, scales=list(x="free"), xlab="cm", horizontal=T)          

bwplot(factor(variable, levels=levels(lp.thk.m$variable)[length(levels(lp.thk.m$variable)):1]) ~ value|variable, data=lp.thk.m, scales=list(x="free"), xlab="cm", horizontal=T)          
```
