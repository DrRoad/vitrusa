---
title: "MLRA 111B - Glynwood B-slope Erosion; Northeastern IN"
author: "Stephen Roecker and Neil Martin"
date: '"Sys.time()"'
output: html_document
---


```{r, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```


```{r setup, echo=FALSE}
## Setup

library(aqp)
library(soilDB)

library(reshape2)
library(ggplot2)
library(gridExtra)
library(knitr)

library(cluster)
library(caret)
library(party)
library(vegan)

library(rgdal)
library(sp)
library(mapview)

source("../queries/test.R")

options(stringsAsFactors = FALSE)
```


## Introduction

This analysis looks at the field data collected for the following 2017 MLRA project:
- MLRA 111B - Glynwood B-slope Erosion; Northeastern IN 


## Import Data and Transform

```{r read and tranform}
project <- get_sdjr_NASIS_db()
project_mu <- project[!duplicated(project$nationalmusym), c("nationalmusym", "muname")]
gw_se <- seriesExtent("Glynwood")
gw_pol <- readOGR("C:/workspace/glynwood.shp", layer = "glynwood")
ssa <- readOGR(dsn = "M:/geodata/soils/soilsa_a_nrcs.shp", layer = "soilsa_a_nrcs")

data <- read.csv("C:/Users/stephen.roecker/ownCloud/projects/neil_arcsie/Pts_gnbero_27Jan17.csv")
ero_labels <- c("undisturbed", "slight", "moderate", "severe")
data <- transform(data,
                  EroClassFD = factor(EroClassFD, levels = 0:3, labels = ero_labels),
                  EroClassSIE = factor(EroClassSIE, levels = 0:3, labels = ero_labels),
                  rgb = munsell2rgb(mxhue, mxvalue, mxchroma, return_triplets = TRUE)
                  )

data_sp <- data
coordinates(data_sp) <- ~ long + lat
proj4string(data_sp) <- CRS("+init=epsg:4326")
data_sp2 <- spTransform(data_sp, CRS(proj4string(gw_pol)))
# writeOGR(data_sp2, dsn = "C:/Users/stephen.roecker/ownCloud/projects", layer = "201711FIN001", driver = "ESRI Shapefile")
data <- cbind(data, over(data_sp2, gw_pol))
data <- merge(data, project_mu, by.x = "nationalmu", by.y = "nationalmusym", all.x = TRUE, sort = FALSE)
data <- within(data, {
  EroClassNASIS = NA
  EroClassNASIS[grepl("eroded", muname)] = "eroded"
  EroClassNASIS[grepl("sev.|severely", muname)] = "sev.eroded"
  EroClassNASIS[!grepl("eroded", muname)] = "non.eroded"
  })
```


# Evaluate the Project by AREASYMBOL

```{r}
ssa_sub <- subset(ssa, areasymbol %in% unique(data$AREASYMBOL))
ssa_sub <- spTransform(ssa_sub, CRS("+init=epsg:4326"))

mapView(gw_se) + ssa_sub + data_sp

vals2 <- c("EroClassFD", "EroClassNASIS", "nationalmu", "AREASYMBOL")
data_sub <- data[, vals2]
data_sub2 <- by(data_sub, data_sub$nationalmu, function(x) {
  x[, vals2]
  x[, 4] <- "MLRA"
  return(x)
  })
data_sub2 <- do.call("rbind", data_sub2)
data_sub <- rbind(data_sub, data_sub2)
data_sub$natmuSsaEro <-  with(data_sub, 
                              paste0(nationalmu, "-", AREASYMBOL, "-", EroClassNASIS)
                              )
test <- with(data_sub, 
             table(natmuSsaEro, EroClassFD)
             )
kable(test, caption = "Frequence by MUSYM-SSA-EROSION")
kable(round(prop.table(test, 1) * 100), caption = "Percent by MUSYM-SSA-EROSION")
```


## Evaluation of the Accuracy of the ArcSIE Predictions

```{r analyze}
cm <- confusionMatrix(data = data$EroClassSIE, reference = data$EroClassFD)
print(cm)

test <- as.data.frame(cm$table)

ggplot(test, aes(x = Reference, y = Freq, fill = Prediction)) +
  geom_bar(stat = "identity")
```


### Boxplots of the Erosion Classes

```{r EroClassFD boxplots, fig.height=7, fig.width=7.5}
soil_vals <- c("hzthk", "SolumDp", "CaCO3Dp", "claytotest", "firstbtclay", "mxvalue", "mxchroma")
geo_vals <- c("SlopeSIE", "ProfCrv", "PlanCrv", "relpos", "wetness")
vals <- c(soil_vals, geo_vals)

data_lo1 <- melt(data, id.vars = "EroClassFD", measure.vars = vals)
data_lo2 <- melt(data, id.vars = "EroClassSIE", measure.vars = vals)

names(data_lo1)[1] <- "EroClass"
data_lo1$method <- "FD"
names(data_lo2)[1] <- "EroClass"
data_lo2$method <- "SIE"
data_lo <- rbind(data_lo1, data_lo2)

# # reshape with base
# data_lo1 <- reshape(data, 
#                      times = vals, timevar = "variable",
#                      varying = vals, v.names = "value",
#                      direction = "long",
#                      drop = which(!names(data) %in% c("EroClassFD", vals))
#                      )
# 
# # reshape with tidyr
# idx <- which(names(data) %in% vals)
# data_lo1 <- select(data, EroClassFD, idx) %>%
#   gather(key = variable, value = value, - EroClassFD)
# data_lo2 <- select(data, EroClassSIE, idx) %>%
#   gather(key = variable, value = value, - EroClassSIE)


ggplot(data_lo, aes(x = EroClass, y = value)) +
  geom_boxplot() +
  facet_wrap(~ paste(variable, method), scales="free") +
  coord_flip()
```


### Scatterplots of the Erosion Classes

```{r mda, fig.height=4, fig.width=7.5}
soil_vals2 <- c("hzthk", "SolumDp", "CaCO3Dp", "claytotest", "firstbtclay") # excluded color, only observed a narrow range thus small differences swamp everthing else
vals <- c(soil_vals2, geo_vals)

test <- data[, vals]
test_d <- daisy(scale(test), metric = "gower")
test_mds <- metaMDS(test_d, distance = "gower", autotransform = FALSE, trace = FALSE)
test_pts <- cbind(as.data.frame(test_mds$points), EroClassFD = data$EroClassFD)

g1 <- ggplot(data, aes(x = hzthk, y = SolumDp, color = EroClassFD)) +
  geom_point(cex = 2, alpha = 0.75) +
  theme(aspect.ratio = 1)
g2 <- ggplot(test_pts, aes(x = MDS1, y = MDS2, color = EroClassFD)) +
  geom_point(cex = 2, alpha = 0.75) +
  theme(aspect.ratio = 1)
grid.arrange(g1, g2, ncol = 2)
```


## Comparison of the Erosion Classes and Hierachical Clusters


```{r ca, fig.height=4, fig.width=7.5}
test_c <- hclust(test_d, method = "ward")
plot(test_c, labels = data$upedonid)
rect.hclust(test_c, k = 3)
```


```{r}
clusters <- cbind(data, 
                  test_pts[, 1:2], 
                  clusters = factor(cutree(test_c, k = 4),
                                    levels = 4:1,
                                    labels = ero_labels
                                    )
                  )

with(clusters, table(EroClassFD, clusters))
with(clusters, table(EroClassSIE, clusters))
```


### Scatter Plots of the Erosion Classes vs the Hierachical Clusters

```{r}
g1 <- ggplot(clusters, aes(x = MDS1, y = MDS2, col = EroClassFD)) +
  geom_point(cex = 3) +
  theme(aspect.ratio = 1)
g2 <- ggplot(clusters, aes(x = MDS1, y = MDS2, col = clusters), main = "test") +
  geom_point(cex = 3) +
  theme(aspect.ratio = 1)
grid.arrange(g1, g2, ncol = 2)
```

In comparison the hierarchical clusters have considerably less overlap when viewed along the multidimensional scaled axes.


### Box Plots fo the Erosion Classes vs the Hierachical Clusters

```{r, fig.height=7, fig.width=7.5}
data_lo3 <- melt(clusters, id.vars = "clusters", measure.vars = vals)

names(data_lo3)[1] <- "EroClass"
data_lo3$method <- "clusters"
data_lo <- rbind(data_lo1, data_lo3)

ggplot(data_lo, aes(x = EroClass, y = value)) +
  geom_boxplot() +
  facet_wrap(~ paste(variable, method), scales="free", ncol = 4) + 
  coord_flip()
```


### Classification Trees


#### FD Classes vs Soil Properties

```{r tree, fig.width=7.5}
clusters <- subset(clusters, !is.na(EroClassFD))

test1 <- ctree(EroClassFD ~ ., data = clusters[, c("EroClassFD", soil_vals)])
plot(test1)
confusionMatrix(data = predict(test1, type = "response"), reference = clusters$EroClassFD)
```


#### Clusters vs Soil Properties

```{r, fig.width=7.5}
test2 <- ctree(clusters ~ ., data = clusters[, c("clusters", soil_vals)])
plot(test2)
confusionMatrix(data = predict(test2, type = "response"), reference = clusters$clusters)
```


#### FD Classes vs DEM Derivatives

```{r, fig.width=7.5}
test3 <- ctree(EroClassFD ~ ., data = clusters[, c("EroClassFD", geo_vals)])
plot(test3)
confusionMatrix(data = predict(test3, type = "response"), reference = clusters$EroClassFD)

test3 <- cforest(EroClassFD ~ ., data = clusters[, c("EroClassFD", geo_vals)])
varimp(test3)
confusionMatrix(data = predict(test3, type = "response"), reference = clusters$EroClassFD)
```


#### Clusters vs DEM Derivatives

```{r, fig.width=7.5}
test4 <- ctree(clusters ~ ., data = clusters[, c("clusters", geo_vals)])
plot(test4)
confusionMatrix(data = predict(test4, type = "response"), reference = clusters$clusters)

test4 <- cforest(clusters ~ ., data = clusters[, c("clusters", geo_vals)])
varimp(test4)
confusionMatrix(data = predict(test4, type = "response"), reference = clusters$clusters)
```


## Summary

