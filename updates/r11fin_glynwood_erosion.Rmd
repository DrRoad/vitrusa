---
title: "Analysis of 11-FIN ArcSIE Erosion Classes"
author: "Stephen Roecker"
date: '"Sys.time"'
output:
  html_document:
    keep_md: yes
  word_document: default
---


```{r, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```


```{r setup, echo=FALSE}
## Setup

library(aqp)
library(soilDB)

library(reshape2)
library(ggplot2)
library(gridExtra)

library(cluster)
library(caret)
library(party)
library(vegan)

library(rgdal)
library(sp)
library(mapview)

options(stringsAsFactors = FALSE)
```


## Introduction

This analysis looks at the field data collected for the following 2017 MLRA projects:
- MLRA 111B - Glynwood B-slope Erosion; Northeastern IN 

One of the goals of these projects was to develop an ArcSIE model in order to differentiate erosion classes. The analysis below is intended to evaluate the field data and ArcSIE model.


## Import Data and Transform

```{r read and tranform}
project <- get_sdjr_NASIS_db()
project <- project[!duplicated(project$nationalmusym), ]
gw_se <- seriesExtent("Glynwood")
gw_pol <- readOGR("C:/workspace/glynwood.shp", layer = "glynwood")
ssa <- readOGR(dsn = "M:/geodata/soils/soilsa_a_nrcs.shp", layer = "soilsa_a_nrcs")
ssa_sub <- subset(ssa, areasymbol %in% project$areasymbol)
ssa_sub <- spTransform(ssa_sub, CRS("+init=epsg:4326"))

data <- read.csv("C:/Users/stephen.roecker/ownCloud/projects/neil_arcsie/Pts_gnbero_27Jan17.csv")
ero_labels <- c("undisturbed", "slight", "moderate", "severe")
data <- transform(data,
                  EroClassFD = factor(EroClassFD, levels = 0:3, labels = ero_labels),
                  EroClassSIE = factor(EroClassSIE, levels = 0:3, labels = ero_labels),
                  rgb = munsell2rgb(mxhue, mxvalue, mxchroma, return_triplets = TRUE)
                  )

soil_vals <- c("hzthk", "SolumDp", "CaCO3Dp", "claytotest", "firstbtclay", "mxvalue", "mxchroma")
geo_vals <- c("SlopeSIE", "ProfCrv", "PlanCrv", "relpos", "wetness")
vals <- c(soil_vals, geo_vals)

data_sp <- data
coordinates(data_sp) <- ~ long + lat
proj4string(data_sp) <- CRS("+init=epsg:4326")
data_sp2 <- spTransform(data_sp, CRS(proj4string(gw_pol)))
data <- cbind(data, over(data_sp2, gw_pol))
data <- merge(data, project, by.x = "nationalmu", by.y = "nationalmusym", all.x = TRUE, sort = FALSE)
data <- within(data, {
  EroClassNASIS = NA
  EroClassNASIS[grepl("eroded", muname)] = "eroded"
  EroClassNASIS[grepl("sev.|severely", muname)] = "sev.eroded"
  EroClassNASIS[!grepl("eroded", muname)] = "non.eroded"
})
```


# Evaluate the Project by AREASYMBOL

```{r}
mapView(gw_se) + ssa_sub + data_sp

vals <- c("EroClassFD", "EroClassNASIS", "nationalmu", "AREASYMBOL", "natmuAS")
data_sub <- data[, vals]
data_sub2 <- by(data_sub, data_sub$nationalmu, function(x) {
  x[, vals]
  x[, 4] <- "MLRA"
  return(x)
  })
data_sub2 <- do.call("rbind", data_sub2)
data_sub <- rbind(data_sub, data_sub2)
data_sub$natmuAS <-  with(data_sub, paste0(nationalmu, "-", AREASYMBOL, "-", EroClassNASIS))

test <- with(data_sub, table(natmuAS, EroClassFD))
test
round(prop.table(test, 1) * 100)
```




## Evaluation of the Accuracy of the ArcSIE Predictions

```{r analyze}
confusionMatrix(data = data$EroClassSIE, reference = data$EroClassFD)

cm$table
round(cm$overall, 2)
round(cm$byClass, 2)

test <- as.data.frame(cm$table)

ggplot(test, aes(x = Reference, y = Freq, fill = Prediction)) +
  geom_bar(stat = "identity")
```

The overall accuracy of the ArcSIE predictions is `r round(cm$overall[1], 2)`. The confusion matrix above shows that the ArcSIE model was only able to able to discriminate EroClassFD class 1 and 2 approximately `r round(mean(cm$byClass[c(2, 3), 11]), 2)` of the time. The barchart shows this breakdown visually. Since the initial sampling, Tonie Endres has reviewed some of the observations where the field determined class differed from the ArcSIE class and determined that the ArcSIE classes were reasonable although the soil properties were not significantly different, thus the overall accuracy is somewhat higher.


### Boxplots of the Erosion Classes

```{r EroClassFD boxplots, fig.height=7, fig.width=7.5}
data_lo1 <- melt(data, id.vars = "EroClassFD", measure.vars = vals)
data_lo2 <- melt(data, id.vars = "EroClassSIE", measure.vars = vals)

names(data_lo1)[1] <- "EroClass"
data_lo1$method <- "FD"
names(data_lo2)[1] <- "EroClass"
data_lo2$method <- "SIE"
data_lo <- rbind(data_lo1, data_lo2)

# # reshape with base
# data_lo1 <- reshape(data, 
#                      times = vals, timevar = "variable",
#                      varying = vals, v.names = "value",
#                      direction = "long",
#                      drop = which(!names(data) %in% c("EroClassFD", vals))
#                      )
# 
# # reshape with tidyr
# idx <- which(names(data) %in% vals)
# data_lo1 <- select(data, EroClassFD, idx) %>%
#   gather(key = variable, value = value, - EroClassFD)
# data_lo2 <- select(data, EroClassSIE, idx) %>%
#   gather(key = variable, value = value, - EroClassSIE)


ggplot(data_lo, aes(x = EroClass, y = value)) +
  geom_boxplot() +
  facet_wrap(~ paste(variable, method), scales="free_y", ncol = 4)
```

The box plots show that the FD erosion classes have a linear trend for some variables, while other variables only show class 3 or 1 deviating from the other two classes. Overall the variation within each of the classes overlap considerably, such that in many cases the median values of one class falls within the interquartile range (e.g. 50%) of the other two classes. This overlap suggests that it is difficult/impractical to separate all the classes. Another interpretation is that a complex exist, however in this instance Tonie Endres has determined that adjacent classes would qualify as similar soils. In comparison, the trends between the SIE classes and variables appear to be less linear. The most important feature to highlight is that the trends between the SIE classes and digital elevation model (DEM) derivatives (i.e. slope) don't match those observed for the FD classes. This mismatch suggests that the membership functions for the SIE classes are a poor fit, and should be redefined to more accurately represent the relationship between the FD classes and DEM derivatives.


### Scatterplots of the Erosion Classes

```{r mda, fig.height=4, fig.width=7.5}
soil_vals2 <- c("hzthk", "SolumDp", "CaCO3Dp", "claytotest", "firstbtclay") # excluded color, only observed a narrow range thus small differences swamp everthing else
vals <- c(soil_vals2, geo_vals)

test <- data[, vals]
test_d <- daisy(scale(test), metric = "gower")
test_mds <- metaMDS(test_d, distance = "gower", autotransform = FALSE, trace = FALSE)
test_pts <- cbind(as.data.frame(test_mds$points), EroClassFD = data$EroClassFD)

g1 <- ggplot(data, aes(x = hzthk, y = SolumDp, color = EroClassFD)) +
  geom_point(cex = 2, alpha = 0.75) +
  theme(aspect.ratio = 1)
g2 <- ggplot(test_pts, aes(x = MDS1, y = MDS2, color = EroClassFD)) +
  geom_point(cex = 2, alpha = 0.75) +
  theme(aspect.ratio = 1)
grid.arrange(g1, g2, ncol = 2)
```


The scatter plots of the erosion classes displayed over various dimensions, including using multidimensional (MD) scaling, again show their is considerable overlap between the erosion classes. 



## Comparison of the Erosion Classes and Hierachical Clusters


```{r ca, fig.height=4, fig.width=7.5}
test_c <- hclust(test_d, method = "ward")
plot(test_c, labels = data$upedonid)
rect.hclust(test_c, k = 3)
```

A hierarchical classification of the field data was generated in order to compare with the FD classes and determine if a more compact classification could be achieved. An threshold of 3 classes was selected. In examining the dendrogram it is apparent that one class is it much smaller than the other two.


```{r}
clusters <- cbind(data, 
                  test_pts[, 1:2], 
                  clusters = factor(cutree(test_c, k = 4), levels = 0:4))

with(clusters, table(EroClassFD, clusters))
with(clusters, table(EroClassSIE, clusters))
```

The contingency table shows that the FD class (EroClassFD) 1 overlaps the most with cluster 2, while FD class 2 overlap the most with the cluster 3. The ArcSIE predictions don't appear to have any correspondence with the hierarchical clusters.


### Scatter Plots of the Erosion Classes vs the Hierachical Clusters

```{r}
g1 <- ggplot(clusters, aes(x = MDS1, y = MDS2, col = EroClassFD)) +
  geom_point(cex = 3) +
  theme(aspect.ratio = 1)
g2 <- ggplot(clusters, aes(x = MDS1, y = MDS2, col = clusters), main = "test") +
  geom_point(cex = 3) +
  theme(aspect.ratio = 1)
grid.arrange(g1, g2, ncol = 2)
```

In comparison the hierarchical clusters have considerably less overlap when viewed along the multidimensional scaled axes.


### Box Plots fo the Erosion Classes vs the Hierachical Clusters

```{r, fig.height=7, fig.width=7.5}
data_lo3 <- melt(clusters, id.vars = "clusters", measure.vars = vals)

names(data_lo3)[1] <- "EroClass"
data_lo3$method <- "clusters"
data_lo <- rbind(data_lo1, data_lo3)

ggplot(data_lo, aes(x = EroClass, y = value)) +
  geom_boxplot() +
  facet_wrap(~ paste(variable, method), scales="free_y", ncol = 4)
```

In comparison the erosion classes and hierarchical clusters show a similarly degree of separability, but appear to be split on different variables. Amongst the clusters, the separation primarily appears to be based on the subsurface properties, such as solum and carbonates depth. In comparision the FD classes appear to be based most on the surface properties of the Ap horizon (hzthk, claytotest, SurfFrags). Because the clusters are differentiated based on subsurface soil properties, it suggests that they developed differently prior to human-induced erosion. It may be interesting to exclude the subsurface properties or downweight the subsurface properties and compute a new hierarchical classification.


### Classification Trees

In order to interpret the FD classes and clusters several classifications trees were constructed. Trees were constructed using both the soil properties and DEM derivatives separately, in order to determine what thresholds best defined the groups internally (e.g. how they might be best classified) and externally (e.g. how they might be mapped). It is worth mentioning that classification trees only look for the single best split amongst individual nodes, while an SIE model is typically a weighted average of several variables. 


#### FD Classes vs Soil Properties

```{r tree, fig.width=7.5}
clusters <- subset(clusters, !is.na(EroClassFD))

test1 <- ctree(EroClassFD ~ ., data = clusters[, c("EroClassFD", soil_vals)])
plot(test1)
cm1 <- confusionMatrix(data = predict(test1, type = "response"), reference = clusters$EroClassFD)
cm1$table
round(cm1$overall, 2)
```

The classification tree of the FD classes using only the soil properties as predictors split the classes on horizon thickness (hzthk) using a break of 21-cm, and had an overall accuracy of `r round(cm1$overall[1], 2)`. The breakdown the of individual nodes show that node 2 is more mixed than node 3. This result is similar to the SIE model which had difficulty separating class 2 and 3. The split at 21-cm approximately corresponds with the depth typically associated with tillage.


#### Clusters vs Soil Properties

```{r, fig.width=7.5}
test2 <- ctree(clusters ~ ., data = clusters[, c("clusters", soil_vals)])
plot(test2)
cm2 <- confusionMatrix(data = predict(test2, type = "response"), reference = clusters$clusters)
cm2$table
round(cm2$overall, 2)
```

The classification tree for the hierarchical clusters using only soil properties as predictors, had several splits based on solum depth (SolumDp) and surface rock fragments (SurfFrags), and had an overall accuracy of `r round(cm2$overall[1], 2)`.


#### FD Classes vs DEM Derivatives

```{r, fig.width=7.5}
test3 <- ctree(EroClassFD ~ ., data = clusters[, c("EroClassFD", geo_vals)])
plot(test3)
cm3 <- confusionMatrix(data = predict(test3, type = "response"), reference = clusters$EroClassFD)
cm3$table
round(cm3$overall, 2)
```

The classification tree of the FD classes using only the DEM derivatives as predictors found the best split using a slope gradient of 6 percent, and had an overall accuracy of `r round(cm3$overall[1], 2)`. This tree however was only able to map classes 1 and 3. The split at a slope of 6 percent matches the original slope break used within Morrow (OH117) and Knox (OH083) Counties to separate B1 (non-eroded, class 1) and B2 (eroded, class 2) slopes. Perhaps B2 slopes need to be updated to class 3.


#### Clusters vs DEM Derivatives

```{r, fig.width=7.5}
test4 <- ctree(clusters ~ ., data = clusters[, c("clusters", geo_vals)])
plot(test4)
cm4 <- confusionMatrix(data = predict(test4, type = "response"), reference = clusters$clusters)
cm4$table
round(cm4$overall, 2)
```

The classification tree of the clusters using only the DEM derivatives as predictors found the best split using across slope (PlanCrv) curvature, and had an overall accuracy of `r round(cm4$overall[1], 2)`. This resulted in a separation of classes 1 and 2, with class 2 occuring on convex positions (e.g. nose slopes). Given the narrow range in slope it seems logical that slope was not the dominant factor. 


## Summary

In summary the field determined (FD) erosion classes show a considerable amount of overlap in the soil properties evaluated. This overlap is likely reducing the accuracy of the ArcSIE, which is only ~ 50% overall. During the field assist the ambiguity of the erosion class definitions from the Soil Survey Manual and operator bias were discussed. Since the initial sampling, Tonie Endres has reviewed some of the observations where the field determined class differed from the ArcSIE class and determined that the ArcSIE classes were reasonable although the soil properties were not significantly different, thus the overall accuracy is maybe somewhat higher. Eitherway their appears to be confusion as to the proper field intrepretation of the erosion classes, their historic application, and whether the definition needs to be reassessed nationally. The most simplistic approach would be to compare the epipedon thickness to some undisturbed reference (which was likely to vary pre-european settlement). A classification tree of the existing FD classes showed that an Ap bottom depth of 21-cm would make the best split, which corresponds with the typically depth of tillage. When the FD classes were compared aganist hierarchical clusters it showed that a more compact classification could be achieved, but that the resulting clusters were predominately the result of the subsurface properties. In important point observed from an evalution of the SIE classes and DEM derivatives with box plots showed they didn't match the FD class landscape patterns. This mismatch indicates that the SIE membership functions should be adjusted, which may also increase the accuracy.

The only digital soil mapping (DSM) approach evaluated in this project was ArcSIE. In comparison with other DSM approaches, ArcSIE is referred to as knowledge-based, where the model or membership functions are manually defined, as opposed to a data-driven approach (i.e. statistical) where the model is derived from the data. The ArcSIE approach is particularly advantageous where their exist limited field data, but abundance of expert knowledge. Alternatively ArcSIE can be used to generate a working hypothesis, prior to sampling. Given that `r nrow(data)` pedon observations exist for this project their is potential to use a data-driven technique. In addition, data from adjacent areas, similiar soils, or other projects could also be used.

At this time the evaluation shows that several adjustments/iterations should be made to the ArcSIE Erosion Class model in quesiton. Below are several recommendations that should be investigated prior to finalizing the ArcSIE model. 

Recommendations:

- Adjust the SIE membership functions to reflect the landscape patterns in the FD classes and DEM derivatives
- Evaluate other applicable DSM models
- Evalute additional DEM derivatives, such as the topographic wetness index (TWI) and relative elevation, and perhaps other measures of curvature designed for low slopes, such as min or max curvature
- Streamline the process to be more production oriented, such as converting the raster product to vector, using a 5 or 10-meter DEM.

This was the first ArcSIE project that has been submitted for QA in Region 11. A large investment has been made in the research and development of ArcSIE and other digital soil mapping (DSM) techniques, therefore Neil Martin and Jennifer Callaway are to be commended for putting this technology to use. Region 11 encourages further use and refinement of ArcSIE and other DSM techniques.