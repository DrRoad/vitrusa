---
title: "Bulk Density in Organic Soils"
author: "Wills et al"
date: "November 17, 2017"
output: html_document
---

comparing datasets

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls()) #clear previous data

require("knitr")
knitr::opts_chunk$set(echo = TRUE, comment = "#", warning = FALSE, message = FALSE, error =FALSE, tidy.opts=list(width.cutoff=60),tidy=TRUE)

opts_knit$set(root.dir = "C:/Users/skye.wills/ownCloud")
workdir <- setwd(getwd()) # personalize the working directory for each user.
opts_knit$set(root.dir = workdir)

list.of.packages <- c("ggplot2", "plyr", "Rcpp", "RColorBrewer", "lattice", "aqp", "stringr", "reshape2", "ggthemes", "tidyverse", "RCurl", "Hmisc", "gridExtra", 'ggmosaic', 'ggpmisc', 'png','rstan','lme4', 'printr', "dplyr","tidyr",  "hexbin", "ggbeeswarm", "viridis", "gridExtra", "cetcolor", "ggjoy")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(Rcpp)
library(RColorBrewer)
library(lattice)
library(stringr)
library(ggthemes)
library(RCurl)
library(rstan)
library(lme4)
library(printr)
library(hexbin)
library(ggbeeswarm)
library(viridis)
library(gridExtra)
library(cetcolor)
library(ggjoy)
library(ggpmisc)

# when ggjoy is decomisioned replace with  "ggridge", 

```


## Bulk Density data

###Bring in datasets with SOC and bulk density across a range of conditions.

**NCSS** - National Cooperative Soil Survey Characterization dataset.  National Cooperative Soil Survey (also known as the soil survey characterization database).  Available by query or Access database at:  https://ncsslabdatamart.sc.egov.usda.gov/. Preparation of this dataset covered as part of the RaCA project, following Wills et al., 2013.
Prepped from the public dataset (Access) from August 2015 following the methods in the RaCA documentation - Prep SOC and BD data.doc.

**RaCA** - Rapid Carbon Assessment Project.  Information and data available at https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_054164

**NWCA** -  National Wetland Condition Assessment. Information and data available at: https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_054164
Data for this project was made available as part of the soil property cooperation with Kellogg Soil Survey Laboratory.


**ISCN** -International Soil Carbon Network. Data available at http://iscn.fluxdata.org/data/data-summary/
Data for this project was supplied by ISCN for BD modeling and population.


**this code chunk downloads data into the folder you set to BD_data - uncomment to run**

```{r dataDownload}

#set folder name to desired download location
BD_data <- "D:/Disk 2/BD_eval/"  #shortcut for personal use

# 
# #download file to the working directory - creates new folder data
# #will save raw data into this folder
# ifelse(!dir.exists(paste0(BD_data,'/data')), dir.create(paste0(BD_data,'/data')), FALSE)  #True means the file was created, FALSE means it alread exsists
# 
# ncss.url <- 'https://nrcs.box.com/shared/static/kroh8h124zligmamsorsk18d98gt9qkd.csv'
# #if file does not exsist, download
# ifelse(!file.exists('data/ncss.w.bd.csv'),download.file(ncss.url, destfile = paste0(BD_data,'/data/ncss.w.bd.csv')), "File already downloaded")
# 
# 
# raca.url <- 'https://nrcs.box.com/shared/static/nivz52qvsgyalx5zir8sgcu7lpp048pl.csv'
# ifelse(!file.exists('data/RaCA_samples.csv'), download.file(raca.url, destfile = paste0(BD_data,'/data/RaCA_samples.csv') )
#        , "File already downloaded")
# 
# nwca.url <- 'https://nrcs.box.com/shared/static/u3qahrgycjzenwxykiabh93cnmk4r1e6.csv'
# ifelse(!file.exists('data/nwca.SOCsamples_5-10.csv'), download.file(nwca.url, destfile = paste0(BD_data,'/data/nwca.SOCsamples_5-10.csv')), "File already downloaded")
#

#ISDCN multiple files must be joined
#Local copy used to derive BD model - includes additional fields such as master horizon
# iscn.url <- 'https://nrcs.box.com/shared/static/4abhdlvwxt8196fs99r25s46spvsmcok.csv'
# ifelse(!file.exists('data/ISCN_BDfill_pred_wMEtA.csv'),download.file(iscn.url, destfile = paste0(BD_data,'/data/ISCN_BDfill_pred_wMEtA.csv')), "File already downloaded")

# # 
# iscnNLCD.url <- 'http://iscn.fluxdata.org/wp-content/uploads/sites/15/ISCN_Template_NLCD.xlsx'
# ifelse(!file.exists('data/ISCN_Template_NLCD.xlsx'),download.file(iscnNLCD.url, destfile = paste0(BD_data,'data/ISCN_Template_NLCD.xlsx')), "File already downloaded")

# iscnPROFILE.url <- 'ftp://ftp.fluxdata.org/.deba/ISCN/ALL-DATA/ISCN_ALL-DATA_PROFILE_1-1.xlsx'
# ifelse(!file.exists('data/ISCN_ALL-DATA_PROFILE_1-1.xlsx'),download.file(iscnPROFILE.url, destfile = paste0(BD_data,'data/ISCN_ALL-DATA_PROFILE_1-1.xlsx')), "File already downloaded")



```


##Read Data into R and Prep
#### Combine dataset into one

* Check field names
* Select relevant fields
* Harmonize datasets
  + Rename to same field names
  + Add SET to denote dataset
  + Add any missing fields (assign values or unknown)
      + LU - to match RaCA W- wetland, C- cropland, P- pastureland, F - Forestland, X- CRP, U added for unknown
  
_Master Horizons (M) set for each dataset in previous data management_
_Texture labels need to be assessed in ensure the same abbreviations are being used_
_wpg for ISCN needs to be converted to volumetric fragment content_


```{r dataPrep}


#load datasets, create common columns, filter and label as needed
ncss <- read.csv(paste0(BD_data, 'data/ncss.w.bd.csv'))
names(ncss)
ncss$SOC <- ifelse(ncss$SOC<0, 0, ncss$SOC)
n <- ncss[!is.na(ncss$BD), c("sample_id", "pedlabsampnum", "top", "bottom", "Model_desg", "M", "tex_psda", "CLAY", "SOC", "CF", "BD")]
names(n) <- c("samp_id", "Pedon_ID", "Top", "Bottom", "Model_desg", "M", "Texture", "Clay", "SOC", "CourseFrag", "BD" )
n$LU <- "U" #U for unknown landuse
n$SET <- "NCSS"

raca <- read.csv(paste0(BD_data,'data/RaCA_samples.csv'))
names(raca)
raca$CALC_SOC <- ifelse(!is.na(raca$caco3),
                        ifelse(raca$caco3>0,raca$c_tot_ncs-(raca$caco3*0.12),raca$c_tot_ncs), raca$c_tot_ncs)
raca$SOC <- ifelse(raca$CALC_SOC<0, 0, raca$CALC_SOC)
r <- raca[!is.na(raca$Measure_BD), c("samp", "upedonid", "TOP", "BOT", "Model_desg", "M", "texture", "fragvolc", "SOC", "Measure_BD", "LU")]
names(r) <- c("samp_id", "Pedon_ID", "Top", "Bottom", "Model_desg", "M", "Texture",  "CourseFrag", "SOC", "BD", "LU" )
r$SET <- "RaCA"
r$Clay <- NA

nwca <- read.csv(paste0(BD_data,'/data/nwca.SOCsamples_5-10.csv'))
names(nwca)
w <- nwca[!is.na(nwca$BD), c( "samp", "Pedon", "top", "bottom", "Model_desg" , "M", "TEXTURE_CLASS", "CLAY", "ROCK_FRAGMENTS", "SOC", "BD")]
names(w) <- c("samp_id", "Pedon_ID" ,"Top", "Bottom", "Model_desg", "M", "Texture", "Clay", "CourseFrag", "SOC", "BD")
w$LU <- "W"
w$SET <- "NWCA"

iscn <- read.csv(paste0(BD_data,'data/ISCN_BDfill_pred_wMEtA.csv'))
names(iscn)
iscn$vpg <- iscn$wpg2*iscn$BD #convert weight coarse frags to volume
i <- iscn[!is.na(iscn$BD), c("layer_name", "profile_name" , "layer_top", "layer_bot", "model_desg" , "M", "CLAY", "vpg", "SOC", "BD") ]
names(i) <- c("samp_id", "Pedon_ID" ,"Top", "Bottom", "Model_desg", "M", "Clay", "CourseFrag", "SOC", "BD")
i$Clay <- as.numeric(i$Clay)
i$Texture <- "U"
i$LU <- "U"
i$SET <- "ISCN"

iscnNLCD <- read.csv(paste0(BD_data,'data/ISCN_Template_NLCD.xlsx'))

iscnPROFILE <- read.csv(paste0(BD_data,'data/ISCN_ALL-DATA_PROFILE_1-1.xlsx'))




#combine dataset into one - missing values are filled with NA
combo <- rbind(n,r,w,i)

#there are a number of really high bulk density numbers - primarily in the ISCN set - need to investigate further
combo <- combo %>% filter(BD<2) 





```


##Compare Datasets
Use dplyr (with piping) to format and ggplot to create graphs

```{r graphs}
d <- combo %>%
  ggplot(aes(BD)) + geom_density(aes(fill = SET), alpha=.5) + scale_x_continuous(limits = c(0,3)) +
  facet_wrap(~M) + ggtitle('Bulk density by Master Horizon')
d

b <- combo %>%
  #filter(!is.na(BD)) %>%
  ggplot(aes(y = BD, x=SET)) + geom_boxplot(aes(fill=LU)) +
  facet_wrap(~M) + ggtitle('Bulk density by Dataset and Land Use/Cover Class')
b

o <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = BD, x=SET)) + geom_boxplot(aes(fill=LU)) +
  ggtitle('For O (organic) horizons only \n Bulk density by Master Horizon and Land Use/Cover Class')
o

s <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = BD, x=SOC)) + geom_point(aes(color=LU, shape = SET)) +
  ggtitle('For O (organic) horizons only \n Bulk density and SOC')
s

S <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=LU, shape = SET)) +
  ggtitle('For O (organic) horizons only \n Bulk density and SOC')
S

Sw <- combo %>%
  filter(!is.na(BD) & M == "O" & LU == "W") %>%
  ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=SET, shape = SET)) +
  ggtitle('For O (organic) horizons in Wetlands only \n Bulk density and SOC')
Sw
```


```{r r-plots}

#joy plot with continuous fill
R <- combo %>%
      filter(!is.na(BD)) %>%
      ggplot(aes(x=BD, y = SET, fill = ..x..)) +  
    geom_joy_gradient()  + 
    scale_fill_gradientn(colours = cet_pal(5, name = "fire"), name = "BD")+
    theme_joy() +
    theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
    labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Ridgeplot of BD by Dataset")

R


#bee swarm
B <- combo %>%
      filter(!is.na(BD)) %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")

B

#add SOC measurement for visulaization
B_C <- combo %>%
      filter(!is.na(BD)&!is.na(SOC) ) %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis()+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")

B_C

#limit to organic horizons
#bee swarm
Bo <- combo %>%
      filter(!is.na(BD) & M =='O') %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of Organic Horizons \n by Dataset")

Bo

Bow <- combo %>%
      filter(!is.na(BD) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

Bow

#with SOC measurement
BoC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n by Dataset")

BoC

BowC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

BowC

BowCc <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W' & SOC>20) %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=14))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons with SOC > 20% \n in Wetlands by Dataset")

BowCc

BowT <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = Top)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "magma")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

BowT

BowTc <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W' & SOC > 20) %>%
  ggplot(aes(x=BD, y = SET, color = Top)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "magma")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

BowTc

```
There is an known accepted relationship between SOC and BD. However, the relationship between the two variables does not appear to be standard by dataset.

```{r explore}

#SOC and BD graphs
ap <- combo %>%
      filter(!is.na(BD) & !is.na(SOC)) %>%
  ggplot(aes(x=BD, y = SOC, color = SET)) + geom_point() + ggtitle("All Samples") +
  ggtitle('BD and SOC all samples')

ap

apf <- combo %>%
      filter(!is.na(BD) & !is.na(SOC)) %>%
  ggplot(aes(x=SOC, y = BD)) + geom_point() + facet_wrap(~SET)
  ggtitle('SOC and BD all samples')

apf


#evaluate by LU and horizon
YPm <- combo %>%
      filter(!is.na(BD) & !is.na(SOC)) %>%
  ggplot(aes(x=SOC, y = BD)) + geom_point(aes(shape = M, color = LU)) + facet_wrap(~SET) +
    ggtitle('BD and SOC -- All samples, by LU and Master')
YPm


op <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & M =='O') %>%
  ggplot(aes(x=BD, y = SOC, color = SET)) + geom_point() + ggtitle("Organic Samples") +
  ggtitle('BD and SOC -- Samples with O designation') +  scale_color_hue(l=40)

opf <- op + facet_wrap(~SET)
opf

opc <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & M =='O' & SOC > 20) %>%
  ggplot(aes(x=BD, y = SOC, color = SET)) + geom_point() + ggtitle("Organic Samples") +
  ggtitle('BD and SOC -- Organic samples, SOC > 20 %') + facet_wrap(~SET)+
  scale_color_hue(l=40)
opc


cop <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & M =='O' & SOC > 20) %>%
  ggplot(aes(x=SOC, y = BD, color = SET)) + geom_point() + ggtitle("Organic Samples") +
  ggtitle('BD and SOC -- Organic samples, SOC > 20') + facet_wrap(~SET)
cop



YPf <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & M =='O' & SOC > 20) %>%
  ggplot(aes(x=SOC, y = BD)) + geom_point(aes(color = LU)) + facet_wrap(~SET)+
    ggtitle('BD and SOC -- Organic samples, SOC > 20; by LU')
YPf



#evaluate only wetlands

YPf <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & M =='O' & SOC > 20 & LU =='W') %>%
  ggplot(aes(x=SOC, y = BD)) + geom_point(aes()) + facet_wrap(~SET)+
    ggtitle('SOC and BD -- Organic samples, SOC > 20, in Wetlands')
YPf

wp <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=SOC, y = BD, color = SET)) + geom_point() + 
  ggtitle("SOC and BD -- Organic Samples in Wetlands")

wp



```

###RaCA Methods

There is obviously something different about the RaCA dataset.  Is it that these haven't been 'cleaned' in the same manner as NWCA and ISCN.  NCSS derived rules were used to clean the RaCA dataset - but there are not many organic horizons in the dataset (may need to update, there is some more recent data).  Wanted to evaluate the distribution of organic horizon BD by method used and region (which office collected and did initial QA of the data).  Mthods can be found in the RaCA documentation
```{r raca_issue}

hp <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & SET == "RaCA")


YhPm <- hp %>%
  ggplot(aes(x=SOC, y = BD)) + geom_point(aes(shape = M, color = LU)) + facet_wrap(~SET) +
  ggtitle('RaCA Samples by LU and Master Horizon')


#use hex plots to look at density of samples

hex <-  ggplot(data = hp, aes(x=SOC, y = BD))  + geom_hex(bins = 75) +
        scale_fill_gradient2(low = "blue", mid = "white", high = "green", midpoint = 150) +
        ggtitle("RaCA Samples - ALL")

ho <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & SET == "RaCA" & M =='O') %>%
  ggplot(aes(x=SOC, y = BD)) + ggtitle("RaCA -- Organic") + geom_hex(bins = 25) +
        scale_fill_gradient2(low = "blue", mid = "white", high = "green", midpoint = 25)


how <- combo %>%
      filter(!is.na(BD) & !is.na(SOC) & SET == "RaCA" & M =='O' & LU =='W' & SOC > 20) %>%
  ggplot(aes(x=BD, y = SOC)) + ggtitle("RaCA -- Organic - Wetland") + geom_hex(bins = 25) +
        scale_fill_gradient2(low = "blue", mid = "white", high = "green", midpoint = 10)
 
 grid.arrange(hex, ho, how, ncol = 2)
 
 

#alternate hex
library(hexbin)
library(RColorBrewer)

# Make the plot
bin<-hexbin(hp$SOC, hp$BD, xbins=40)
my_colors=colorRampPalette(rev(brewer.pal(11,'Spectral')))
plot(bin, main="" , colramp=my_colors , legend=F ) 


#evaluate methods

am <- raca %>% 
      filter(!is.na(Measure_BD) & !is.na(SOC)) %>%
       mutate(BD = Measure_BD) %>%
        ggplot(aes(x=BD, y = SOC)) + ggtitle("RaCA ALL Samples") + geom_point(aes(color = BD)) +
         scale_color_gradient2(low = "blue", mid = "white", high = "green", midpoint = 0.35) +
      facet_wrap(~BDmethod)

am

#there is a significant number of RaCA samples in the intermediate level of bulk density and some much higher even when SOC is greater than 20%
#add fit from previous work (Sanderman) and break BD into classes based on distribution

r_O <- raca %>% 
      filter(!is.na(Measure_BD) & !is.na(SOC) & M =='O' & LU =='W' & SOC > 20) %>%
      select("rcasiteid", "pedon_no", "MO", "MOGr",  "TOP", "BOT", "hzn_desgn", "Model_desg", "M", "texture", "fragvolc", "caco3", "SOC", "BDmethod", "Measure_BD", "LU") %>%
      mutate(Region = as.factor(MO), BD = Measure_BD, BD_class = cut(BD, breaks = c(0,0.5,1.0, 2.5), labels = c("low", "med", "high")), fit = 0.0906 + 0.8757*exp(-0.0786*SOC) + 0.65528*exp(-1.0975*SOC), dev = BD - fit) 


#write_csv(r_O, "C:/Users/Skye.Wills/ownCloud/AGU_BD-OM/raca-r_O.csv")

mp <-  r_O %>%
        ggplot(aes(x=SOC, y = BD)) + ggtitle("RaCA Organic Wetland Samples") + geom_point(aes(color = BD)) +
        scale_fill_gradient2(low = "blue", mid = "white", high = "green", midpoint = 150) + facet_wrap(~BDmethod)
mp

mbs <- r_O %>%
  ggplot(aes(x=BD, y = BDmethod, color = SOC)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=12))+
  labs(x="Bulk Density",y="Method",caption="@wills_skye", title="Bulk Density of O Horizons in Wetlands")

mbs

library(dplyr) #reloading to use this syntax over plyr

r_sum <- r_O %>%   
            group_by(BD_class) %>%
            summarize(count = length(BD_class),
                bd = mean(BD),      
               soc = mean(SOC),
               t = mean(TOP),
               b = mean(BOT)
               )


#Try to identify some key thing that could indicate BD values outside of 'usual'

r_O %>% group_by(BD_class, BDmethod) %>% summarize(n=length(BD_class)) %>%
  spread(key = BD_class, value = n)

r_O %>% group_by(BD_class, Region) %>% summarize(n=length(BD_class)) %>%
  spread(key = BD_class, value = n)

r_O %>% group_by(BD_class, hzn_desgn) %>% summarize(n=length(BD_class)) %>%
  spread(key = BD_class, value = n)

r_O %>% group_by(BD_class, texture) %>% summarize(n=length(BD_class)) %>%
  spread(key = BD_class, value = n)

#region map for context

#Region averages as derived above by weighted means and regional polygons
url5 <- "https://nrcs.box.com/shared/static/r0dnhdiwy5e7c7c85jva8nbhal6q5amq.png"
if(!file.exists('RaCA_manuscript_Region.png')) download.file(url5, destfile = 'RaCA_manuscript_Region.png',mode = 'wb') 
knitr::include_graphics('RaCA_manuscript_Region.png', auto_pdf = T, dpi = NULL)

MOb <- r_O %>%
  ggplot(aes(x=BD, y = Region, color = SOC)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=12))+
  labs(x="Bulk Density",y="RaCA Region - MO",caption="@wills_skye", title="Bulk Density of O Horizons in Wetlands")

MOb

MOc <- r_O %>%
  ggplot(aes(x=BD, y = Region, color = BD)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=12))+
  labs(x="Bulk Density",y="RaCA Region - MO",caption="@wills_skye", title="Bulk Density of O Horizons in Wetlands")

MOc


#MO10 has a good mix of low, med, and high BD values
r_O %>% filter(MO=="10") %>%
   select(SOC, BD_class, hzn_desgn) %>%
   group_by(BD_class, hzn_desgn) %>%
   summarise(soc = mean(SOC)) %>%
   spread(key = BD_class, value = soc)

#MO14 has  more highs than other MOs
r_O %>% filter(MO=="14") %>%
   select(SOC, BD_class, hzn_desgn) %>%
   group_by(BD_class, hzn_desgn) %>%
   summarise(soc = mean(SOC)) %>%
   spread(key = BD_class, value = soc)


## trying to look at the correlation between sample, pedon and plot problems

raca <- raca %>%
      filter(!is.na(Measure_BD) & !is.na(SOC)) %>%
      select( "samp","rcasiteid", "pedon_no", "MO", "MOGr",  "TOP", "BOT", "hzn_desgn", "Model_desg", "M", "texture", "fragvolc",              "caco3", "SOC", "BDmethod", "Measure_BD", "LU") %>%
      mutate(ped = paste0(rcasiteid, "_", pedon_no), BD = Measure_BD, 
              BD_class = ifelse(M=="O", cut(BD, breaks = c(0,0.5,1.0, 2.5), labels = c("low", "med", "high")),"Mineral"), 
              fit = 0.0906 + 0.8757*exp(-0.0786*SOC) + 0.65528*exp(-1.0975*SOC), 
              dev = BD - fit
             )      

raca %>% select(samp, BDmethod, BD, fit, dev) %>%
  gather(key = TYPE, value = value, - c(samp, BDmethod)) %>% 
  ggplot(aes(value)) + geom_density(aes(fill = TYPE), alpha = 0.5)

raca %>% select(samp, BDmethod, BD, fit, dev) %>%
  ggplot(aes(x=BD, y = fit, color = BDmethod))+ geom_point(aes(color = BDmethod))
#   
# library(dplyr)  
# ped <- raca %>%
#   select(rcasiteid, pedon_no, ped, MO, MOGr, SOC, BD, dev) %>%
#    group_by(ped) %>%
#    summarise_all(funs(min, mean, max)) %>%
#    rename_(.dots=setNames(names(.), tolower(gsub("_", "_ped_", names(.)))))
# 
# site <- raca %>%
#   select(rcasiteid, pedon_no, ped, MO, MOGr, SOC, BD, dev) %>%
#    group_by(rcasiteid) %>%
#    summarise_all(funs(min, mean, max))%>%
#   rename_(.dots=setNames(names(.), tolower(gsub("_", "_site_", names(.)))))
# 
# 
# raca_dev <- raca %>% left_join(ped) %>% left_join(site)
# 
# raca_dev %>% ggplot(aes(bd_ped_mean, bd_site_mean)) + geom_point(aes(color = BD_class)) + ggtitle("Mean Deviation from Modeled BD")
# 
# raca_dev %>% ggplot(aes(dev, bd_site_mean)) + geom_point(aes(color = BD_class)) + ggtitle("Sample vs. Mean Deviation from Modeled BD")
# 
# 
# grid.arrange(
# raca_dev %>% 
# ggplot(aes(x = BD, color = BD_class)) + geom_density(aes(fill = BD_class), alpha= 0.5)+ ggtitle("BD Classes by distribution") ,
#  raca_dev %>%
# ggplot(aes(x = fit, color = BD_class)) + geom_density(aes(fill = BD_class), alpha= 0.5)+ ggtitle("Deviation from Model by BD class") 
# ,  
# raca_dev %>% 
# ggplot(aes(BD, fit)) + geom_point(aes(color = BD_class)) + ylim(0,2) + xlim(0,2) + ggtitle("all")
# ,
# raca_dev %>% filter(M == "O") %>%
# ggplot(aes(dev, BD)) + geom_point(aes(color = BD_class)) + ylim(0,2) + xlim(-1,2) +ggtitle("Organic")
# ,
# ncol = 2, top = "RaCA Horizons Bulk Density")
# 
# grid.arrange(
# raca_dev %>% filter(M == "O") %>%
# ggplot(aes(x = BD, color = BD_class)) + geom_density(aes(fill = BD_class), alpha= 0.5)+ ggtitle("BD Classes by distribution") ,
#  raca_dev %>% filter(M == "O") %>%
# ggplot(aes(x = dev, color = BD_class)) + geom_density(aes(fill = BD_class), alpha= 0.5)+ ggtitle("Deviation from Model by BD class") 
# ,  
# raca_dev %>% filter(M == "O") %>%
# ggplot(aes(dev, dev_ped_mean)) + geom_point(aes(color = BD_class)) + ylim(-1,2) + xlim(-1,2) + ggtitle("Sample vs. Mean Pedon")
# ,
# raca_dev %>% filter(M == "O") %>%
# ggplot(aes(dev, dev_site_mean)) + geom_point(aes(color = BD_class)) + ylim(-1,2) + xlim(-1,2) +ggtitle("Sample vs. Mean Site")
# ,
# ncol = 2, top = "RaCA Organic Horizons \n dev = BD Measured - BD Model")
# 
# raca_dev %>% ggplot(aes(x = BD, y = SOC)) + geom_point(aes(color = BD_class)) 
# raca_dev %>% ggplot(aes(x = BD, y = fit)) + geom_point(aes(color = BD_class)) + ylim(0,2) + xlim(0,2)
# 
# 
# raca_dev %>% ggplot(aes(x = BD_class, y = bd_site_mean)) + geom_boxplot(aes(fill = BD_class)) 
# raca_dev %>%filter(M == "O")%>% ggplot(aes(x = BD_class, y = bd_site_mean)) + geom_boxplot(aes(fill = BD_class)) 

#No

```

####BD predictions 

Using three basic approaches to fit - mixing model following Morris et al, 2016 with 0.085 set as the bulk density of 100% organic material and 1.99 as the bulk density of material with 0% organic material.

__Morris, James T., Donald C. Barber, John C. Callaway, Randy Chambers, Scott C. Hagen, Charles S. Hopkinson, Beverly J. Johnson et al. "Contributions of organic and inorganic matter to sediment volume and accretion in tidal wetlands at steady state." Earth's future 4, no. 4 (2016): 110-121.__


```{r mixing}

#find lines to predict bulk density 
#from sanderman BD = 0.0906 + 0.8757*exp(-0.0786*OC) + 0.65528*exp(-1.0975*OC)

#Only data with BD and SOC
m <- combo %>%
      filter(!is.na(BD) & !is.na(SOC))

#BASIC graph
yr <- m %>%
        ggplot(aes(x=SOC, y = BD)) + geom_point() +  facet_wrap(~SET)

#linear plot with SOC
ys <- m %>%
        ggplot(aes(x=SOC*1.724, y = 1/BD)) + geom_point() +  facet_wrap(~SET)


#mixing model - estimated from Morris et al., 2016
#best fit a = 8.5 and b = 199

#esimate OM from SOC
m$OM <- m$SOC*1.724
m$OM <- ifelse(m$OM>100, 100, m$OM)

a = 8.5
b = 199

m$morris <- with(m, 1/(OM/a + (100 - OM)/b))

#a and b values altered to better fit range of soils in these datasets
a = 12
b = 166


m %>% ggplot(aes(morris))+geom_density(aes(fill = LU), alpha = 0.5)

m$mix <- with(m, 1/((OM/a) + ((100 - OM)/b)))
             

m %>% ggplot(aes(mix))+geom_density(aes(fill=LU), alpha = 0.5)
 


yr + ggtitle("Theoretical Fit Between SOC and Bulk Density") + guides(color = guide_legend("Model")) +
  geom_line(data=m, aes(y=morris, colour = "Morris")) +
  geom_line(data=m, aes(y=mix, colour = "Mixing"))



```

Known pedotransfer functions that use only SOC
__De Vos, B., Van Meirvenne, M., Quataert, P., Deckers, J., & Muys, B. (2005). Predictive quality of pedotransfer functions for estimating bulk density of forest soils. Soil Science Society of America Journal, 69(2), 500-510.__

Future work will include building texture into these

``` {r PTF}

#regress from  independent dataset
#sanderman BD = 0.0906 + 0.8757*exp(-0.0786*OC) + 0.65528*exp(-1.0975*OC)
m$san <- 0.0906 + 0.8757*exp(-0.0786*m$SOC) + 0.65528*exp(-1.0975*m$SOC)

#Alexandar, 1980 - inorganic horizons
 m$alex <- 1.60 - 0.308*((m$SOC)^0.5)
 
 
 yr + ggtitle("Theoretical Fit Between SOC and Bulk Density") + guides(color = guide_legend("Model")) +
  geom_line(data=m, aes(y=san, colour = "Sanderman")) +
  geom_line(data=m, aes(y=alex, colour = "Alexandar"))
 
#combine best portions based on organic/inorganic split
 m$ptf <- ifelse(m$SOC<18,m$alex,m$san)

  yr + ggtitle("Theoretical Fit Between SOC and Bulk Density") + guides(color = guide_legend("Model")) +
  geom_line(data=m, aes(y=ptf, colour = "PTF combo"))

```


simple regression with SOC

```{r regress}

#find linear model to predict bulk density? 
ys <- m %>%
        ggplot(aes(x=SOC, y = 1/BD)) + geom_point() +  facet_wrap(~SET)
#I really don't came for the look of these, but will test
ys +  geom_smooth(method="lm")

m$r.bd = 1/(m$BD + 0.01)
r.ys <- m %>%
        ggplot(aes(x=SOC, y = r.bd)) + geom_point() +  facet_wrap(~SET) + geom_smooth(method="lm")

lmod <- lm(r.bd ~ SOC, data = m)

summary(lmod)
#metrics don't look great on this one


#fit a polynomial equation
yr + stat_smooth(method = "lm", se = TRUE, formula = y~poly(log(x+0.01), 3, raw = TRUE)) 

pmod <- lm(BD~poly(log(SOC+0.01)), data = m)


library(ggpmisc)
#combine LU with model
formula <- y ~ poly(log(x+0.01), 3, raw = TRUE)
ggplot(m, aes(x=SOC, y= BD)) +
      geom_point() + facet_wrap(~SET) + 
      geom_smooth(method = "lm", formula = formula) +
      stat_poly_eq(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
                   formula = formula, parse = TRUE)

formula <- y ~ poly(exp(-(x+.01), 3, raw = TRUE))
ggplot(m, aes(x=SOC, y= BD, color = LU)) +
      geom_point() + facet_wrap(~SET) + 
      geom_smooth(method = "lm", formula = formula) +
      stat_poly_eq(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
                   formula = formula, parse = TRUE)

#calculate RMSE from model output
rmse <- function(mod) sqrt(mean(mod$residuals^2))

rmse(lmod)
rmse(pmod)

#polynomial is not great - but is better than linear model
m$pmod <- predict(pmod)

```

##Sample Deviation
Calculate range in average (sample) SOC density (bd*SOC) based on esimation methods.
This is not estimating the error associated with any given technique but with the different anwers derived from each technique.
The mixing model and ptf have really distinctive distribution of sample SOC density (especially for organic samples).  The measured bd derived SOC density has a much longer tail.

``` {r dev}
  yr + ggtitle("Theoretical Fit Between SOC and Bulk Density") + guides(color = guide_legend("Model")) +
  geom_line(data=m, aes(y=ptf, colour = "PTF combo")) +
   geom_line(data=m, aes(y=mix, colour = "Mixing")) +
   geom_line(data=m, aes(y=pmod, colour = "Poly Model")) 


m$bd.den <- m$BD*m$SOC 
m$ptf.den <- m$ptf*m$SOC
m$mix.den <- m$mix*m$SOC
m$pmod.den <- m$pmod*m$SOC

den.all <- m %>%
       select(samp_id, SET, bd.den, pmod.den,mix.den,ptf.den) %>%
      gather(key =bd.source, SOC.den, -c(samp_id, SET) ) %>%
      ggplot(aes(SOC.den))+geom_density(aes(fill=bd.source), alpha = 0.5) +   
      scale_color_viridis(discrete = TRUE) +  facet_wrap(~SET) + xlim(0,20) +
      ggtitle("SOC Density for all samples")

den.all

den.box <- m %>%
      select(samp_id, SET, bd.den, pmod.den,mix.den,ptf.den) %>%
      gather(key =bd.source, SOC.den, -c(samp_id, SET) ) %>%
      ggplot(aes(y = SOC.den, x = bd.source))+ geom_boxplot(aes(fill=bd.source), alpha = 0.5) +   
      scale_color_viridis(discrete = TRUE) +  facet_wrap(~SET) + scale_y_log10() +
      ggtitle("SOC Density for all samples") + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1))

den.box

den.sw <-   m %>%
       select(samp_id, SET, bd.den, pmod.den,mix.den,ptf.den) %>%
      gather(key =bd.source, SOC.den, -c(samp_id, SET) ) %>%
      ggplot(aes(x=SOC.den, y = bd.source)) +  
            geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
      theme_joy() +
      theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=18))+
      labs(x="SOC Density",y="Dataset",caption="@wills_skye", title="SOC Density of all samples")
den.sw

#limit to organic horizons
o.den.all <- m %>%
        filter(M == "O") %>%
       select(samp_id, SET, bd.den, pmod.den,mix.den,ptf.den) %>%
          gather(key =bd.source, SOC.den, -c(samp_id, SET) ) %>%
      ggplot(aes(SOC.den))+geom_density(aes(fill=bd.source), alpha = 0.5) +   
      scale_color_viridis(discrete = TRUE) +  facet_wrap(~SET) + xlim(0,20) +
      ggtitle("SOC Density for all samples")

o.den.all

o.den.box <- m %>%    filter(M == "O") %>%
      select(samp_id, SET, bd.den, pmod.den,mix.den,ptf.den) %>%
      gather(key =bd.source, SOC.den, -c(samp_id, SET) ) %>%
      ggplot(aes(y = SOC.den, x = bd.source))+ geom_boxplot(aes(fill=bd.source), alpha = 0.5) +   
      scale_color_viridis(discrete = TRUE) +  facet_wrap(~SET) + scale_x_log10() +
      ggtitle("SOC Density for all samples") + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1))

o.den.box


o.den.sw <-   m %>%
        filter(M == "O") %>%         
    select(samp_id, SET, bd.den, pmod.den,mix.den,ptf.den) %>%
      gather(key =bd.source, SOC.den, -c(samp_id, SET) ) %>%
      ggplot(aes(x=SOC.den, y = bd.source)) +  
            geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
      theme_joy() +
      theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=18))+
      labs(x="SOC Density",y="Dataset",caption="@wills_skye", title="SOC Density of Organic Samples")
o.den.sw




```

##Stock Deviation
Calculate range in average pedon/profile SOC stock (bd*SOC - 100cm?) based on multiple esimation methods
*stock deviation by land use?*
```{r stock, eval=T}

#assign how layers are counted in stock calculations
#puts a number on the amount (cm) of each layer used in calculation
#there are more streamlined ways to do this but this method is maintained from previous work (it is also computationally simple and uses few computing resources)
library(plyr)

m$SOC_5 <- ifelse(m$bottom<=5, m$thick,ifelse(m$top<5, 5-m$top,0))

m$SOC_30 <- ifelse(m$bottom<=30, m$thick,
                    ifelse(m$top<30, 30-m$top,0))

m$SOC_100 <- ifelse(m$bottom<=100, m$thick,
                    ifelse(m$top<100, 100-m$top,0))

#calculate layer stocks - assigned depth * SOCden 
#native units are Mg/ha
m$SOCstock5 <- with(m, SOCden*SOC_5)
m$SOCstock30 <- with(m, SOCden*SOC_30)
m$SOCstock100 <- with(m, SOCden*SOC_100)

#sum SOC by pedon
SOC_5 <- aggregate(SOCstock5~MO + MOGr + LU + MOGrLU + rcasiteid + upedonid + upedon, data=m, FUN=sum)
SOC_30 <- aggregate(SOCstock30~upedonid, data=m, FUN=sum)
SOC_100 <-aggregate(SOCstock100~upedonid, data=m, FUN=sum) 


#additional information about pedons used to screen for pedons that do not meet depth requirements
#pedon id info
ped <- aggregate(mle.id ~MO + MOGr + LU + MOGrLU + rcasiteid + upedonid + upedon, data=m, FUN=length)
names(ped)[8] <- "mle_count"

#pedon information
pedon_thick <- aggregate(thick  ~ upedonid, data=m, FUN=sum)
names(pedon_thick)[2] <- "total_thickness"
ped_bott <- aggregate(bottom~upedonid, data=m, FUN=max)
lab_no <- aggregate(natural_key~upedonid, data=m, FUN=length)
names(lab_no)[2] <- "Lab_count"

mle_notR <- aggregate(mle.id~upedonid, data=m[grep("R", m$model_desg, invert=T, ignore.case=T),] , FUN=length)
names(mle_notR)[2] <- "Non-R_mleCount"

SOC_no <- aggregate(SOC~upedonid, data=m[!is.na(m$SOC), ], FUN=length)
names(SOC_no)[2] <- "SOC_count"

SOC_thick <- aggregate(thick~upedonid, data=m[!is.na(m$SOC), ], FUN=sum)
names(SOC_thick)[2] <- "SOC_thickness"

top <- aggregate(top~upedonid, data=m, FUN=min)
names(top)[2] <- "Pedon_top"

#depth of R or other restrictive layer (assumed to have negligble SOC at this depth and below)

hard <- c("Bkm", "Bkmm", "Bqm", "R", "Cr", "m")
depthR <- aggregate(top~upedonid, data=m[grepl(paste(hard, collapse='|'),  m$model_desg, ignore.case=T),], FUN=min)
names(depthR)[2] <- "Depth_to_R"

depth_O <- aggregate(thick~upedonid, data=m[m$M == "O",], FUN=min)
names(depth_O)[2] <- "Depth_of_O"
depth_O$Depth_of_O <- ifelse(is.na(depth_O$Depth_of_O), 0, depth_O$Depth_of_O)

#combine pedon information

SOC5 <- join(ped, SOC_5, by="upedonid", type="full", match="first")
SOC30 <- join(SOC5, SOC_30, by="upedonid", type="full", match="first")
SOC100 <- join(SOC30,SOC_100, by="upedonid", type="full", match="first")
SOCp <- join(SOC100, pedon_thick, by="upedonid", type="full", match="first")
SOCn <- join(SOCp, SOC_no, by="upedonid", type="full", match="first")
SOCnn <- join(SOCn, lab_no, by="upedonid", type="full", match="first")
SOCpn <- join(SOCnn, depthR, by="upedonid", type="full", match="first")
SOCpp <- join(SOCpn, mle_notR, by="upedonid", type="full", match="first")
SOCpo <- join(SOCpp, depth_O, by="upedonid", type="full", match="first")
SOCpedons <- join(SOCpo, SOC_thick, by="upedonid", type="full", match="first")

#remove unneeded tables
rm(SOC5,SOC30, SOC100, SOCp, SOCn, SOCnn, SOCpp, SOCpo)

                                                      
SOCpedons$USE <-ifelse(SOCpedons$SOCstock5 == 0, 
                                                ifelse(SOCpedons$SOC_count<SOCpedons$Lab_count,"MISS_anal", "MISS_labm"), 
                       ifelse(is.na(SOCpedons$total_thickness), 'NA',
                              ifelse(SOCpedons$SOC_thickness >= SOCpedons$total_thickness, '100',
                                     ifelse(!is.na(SOCpedons$Depth_to_R),  
                                            ifelse(SOCpedons$Depth_to_R <= SOCpedons$SOC_thickness , '100', 
                                                   ifelse(SOCpedons$SOC_thickness >= 100, '100',
                                                          ifelse(SOCpedons$SOC_thickness >= 30, '30',
                                                                 ifelse(SOCpedons$SOC_thickness >= 5, '5', 'NA')))),
                                            ifelse(SOCpedons$SOC_thickness >= 100, '100',
                                                   ifelse(SOCpedons$SOC_thickness >= 30, '30',
                                                          ifelse(SOCpedons$SOC_thickness >= 5, '5', 'NA'))))
                              )))
                        

# check NAs and missing mles
kable( table(SOCpedons$MO,SOCpedons$USE, useNA= "ifany"), caption = "Table S2. Counts of missing mles by depth")
Use.pedons <- ddply(SOCpedons, .(MO), summarise, 
                          N_5= sum(!is.na(SOCstock5)),
                          N_30= sum(!is.na(SOCstock30)),
                          N_100= sum(!is.na(SOCstock100))
)

#kable(Use.pedons, caption = "Count of Pedons with all SOC Data")
  

#keep ones with values
SOCpedons <- SOCpedons[!is.na(SOCpedons$SOCstock5),]
SOCpedons <- SOCpedons[SOCpedons$SOCstock5 != 0,]

#remove stocks based on Use field 
SOCpedons$SOCstock5 <- as.numeric(ifelse(SOCpedons$USE %in% c(5, 30, 100), SOCpedons$SOCstock5, ""))
SOCpedons$SOCstock30 <- as.numeric(ifelse(SOCpedons$USE %in% c(30, 100), SOCpedons$SOCstock30, ""))
SOCpedons$SOCstock100 <- as.numeric(ifelse(SOCpedons$USE %in% c(100), SOCpedons$SOCstock100, ""))

#limit pedon file to those that have useable data
SOCpedons <- SOCpedons[!is.na(SOCpedons$USE),]

#remove unwanted objects
rm(hard, depth_O, depthR, lab_no,ped, ped_bott, pedon_thick, mle_notR, SOC_thick, SOC_100, SOC_30, SOC_5, SOC_no, SOCpn, top)


#export pedon (site) level SOC stocks
#############
write.table(SOCpedons,"BD_SOC_pedons.csv", sep=",", row.names=F)


```

##link stocks to areal estimates
link calculated averages to areal polygons - should give a general idea of what the shift (overestimation) of SOC stocks is


## RaCA - within site variability
use all raca samples to evaluate within site variability

### Other References

**NSSH** - U.S. Department of Agriculture, Natural Resources Conservation Service. National soil survey handbook, title 430-VI.	http://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/ref/?cid=nrcs142p2_054242

Throop, H. L., Archer, S. R., Monger, H. C., & Waltman, S. (2012). When bulk density methods matter: Implications for estimating soil organic carbon pools in rocky soils. Journal of Arid Environments, 77, 66-71.

Goidts, Esther, Bas Van Wesemael, and Michel Crucifix. "Magnitude and sources of uncertainties in soil organic carbon (SOC) stock assessments at various scales." European Journal of Soil Science 60, no. 5 (2009): 723-739.

K?chy, M., R. Hiederer, and A. Freibauer. "Global distribution of soil organic carbon-Part 1: Masses and frequency distributions of SOC stocks for the tropics, permafrost regions, wetlands, and the world." Soil 1, no. 1 (2015): 351-365.


#Later
##SSURGO component horizons

This takes component horizons from SDA and looks at the distribution of BD and SOC
BD= dbthirdbar_r
soc = om_r/1.724

*may want to limit this to map unit components that intersect with these datasets*

``` {r ssurgo}

# #ss <- read_delim("D:/Disk 2/DATA/SSURGO_chorizon.txt", delim = "|")
# 
# 
# library(data.table)
# 
# ss <- fread("D:/Disk 2/DATA/SSURGO_chorizon.txt", sep = "|")
# 
# #fwrite(ss, "ssurgo_comp.csv")
# names(ss)
# names(ss)[16] <- "dbthirdbar_r_repeat"
# 
# ss <- as.data.frame(ss)
# 
# # make strip charts - add to other datsets
# # error - need to go back and fix SDA query
# 
# 
# ss$BD <- ss$dbthirdbar_r
# ss$SOC <- ss$om_r/1.724
# 
# bd <- ss %>%
#   filter(!is.na(BD)) %>%
#   ggplot(aes(y = BD, x = 1)) + geom_boxplot()+
#   ggtitle('Bulk Density values in SSURGO') + xlab('SSURGO')
# bd
# 
# bdS <- ss %>%
#   filter(!is.na(BD) & !is.na(SOC)) %>%
#   ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color = mlraoffice)) +
#   ggtitle('SSURGO VAlues \n Bulk density and SOC')
# bdS
# 
# #only for O horizons
# bo <- ss %>%
#   filter(!is.na(BD) & grepl("O", hzname, ignore.case=T) & !grepl("B", hzname, ignore.case=T)) %>%
#   ggplot(aes(y = BD, x = "SSURGO")) + geom_boxplot() +
#   ggtitle('Organic Horizon \n Bulk Density values in SSURGO')
# bo
# 
# 
# do <- ss %>%
#   filter(!is.na(BD) & grepl("O", hzname, ignore.case=T) & !grepl("B", hzname, ignore.case=T)) %>%
#   ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=mlraoffice)) + xlim(0,70) +
#   ggtitle('Organic Horizon SSURGO VAlues \n Bulk density and SOC')
# do
# 
# grid.arrange(b,bd,o,bo, ncol = 2)
# 
# grid.arrange(S, do)
# 
# Or <- ss %>%
#   filter(!is.na(BD) & grepl("O", hzname, ignore.case=T) & !grepl("B", hzname, ignore.case=T)) %>%
#         ggplot(aes(x=SOC, y = BD)) + geom_point() 
# 
# sr <- ss %>%
#   filter(!is.na(BD)) %>%
#         ggplot(aes(x=SOC, y = BD)) + geom_point() 
# 
# 
# ss$fit  = with(ss, 0.0906 + 0.8757*exp(-0.0786*SOC) + 0.65528*exp(-1.0975*SOC))
# 
# sr + stat_smooth(method = "lm", se = TRUE, formula = y~poly(log(x+0.01), 3, raw = TRUE)) +
# geom_line(data=m, aes(y=fit, colour = "red"), width = 3)


```

