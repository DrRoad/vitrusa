---
title: "SWS_NWCA"
author: "Wills et al"
date: "January 4, 2018"
output: html_document
  md_document:
    variant: markdown_github
---

comparing datasets

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls()) #clear previous data

require("knitr")
knitr::opts_chunk$set(echo = TRUE, comment = "#", warning = FALSE, message = FALSE, error =FALSE, tidy.opts=list(width.cutoff=60),tidy=TRUE)

opts_knit$set(root.dir = "C:/Users/skye.wills/ownCloud/AGU_BD-OM")
workdir <- setwd(getwd()) # personalize the working directory for each user.
opts_knit$set(root.dir = workdir)

list.of.packages <- c("ggplot2", "plyr", "Rcpp", "RColorBrewer", "lattice", "aqp", "stringr", "reshape2", "ggthemes", "tidyverse", "RCurl", "Hmisc", "gridExtra", 'ggmosaic', 'ggpmisc', 'png','rstan','lme4', 'printr', "dplyr","tidyr",  "hexbin", "ggbeeswarm", "viridis", "gridExtra", "cetcolor", "ggjoy", "readxl", "sp", "maps", "maptools", "rgdal")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(Rcpp)
library(RColorBrewer)
library(lattice)
library(stringr)
library(ggthemes)
library(RCurl)
library(rstan)
library(lme4)
library(printr)
library(hexbin)
library(ggbeeswarm)
library(viridis)
library(gridExtra)
library(cetcolor)
library(ggjoy)
library(ggpmisc)
library(readxl)
library(sp)
library(maps)
library(maptools)
library(rgdal)

# when ggjoy is decomisioned replace with  "ggridge", 

```



###Bring NWCA and RaCA datasets with SOC and bulk density from publicly availalbe data.  Add location information which is sensitve and only shared with permission.

**RaCA** - Rapid Carbon Assessment Project.  Information and data available at https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_054164

**NWCA** -  National Wetland Condition Assessment. Information and data available at: https://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_054164
Data for this project was made available as part of the soil property cooperation with Kellogg Soil Survey Laboratory.

**this code chunk downloads data into the folder with this project - uncomment to run**

```{r dataDownload}

raca.url <- 'https://nrcs.box.com/shared/static/nivz52qvsgyalx5zir8sgcu7lpp048pl.csv'
ifelse(!file.exists('RaCA_samples.csv'), download.file(raca.url, destfile = paste0('RaCA_samples.csv') )
       , "File already downloaded")

nwca.url <- 'https://nrcs.box.com/shared/static/u3qahrgycjzenwxykiabh93cnmk4r1e6.csv'
ifelse(!file.exists('nwca.SOCsamples_5-10.csv'), download.file(nwca.url, destfile = paste0('nwca.SOCsamples_5-10.csv')), "File already downloaded")


```


##Read Data into R and Prep
#### Combine dataset into one

* Add location data
* Check field names
* Select relevant fields
* Harmonize datasets
  + Rename to same field names
  + Add SET to denote dataset
  + Add any missing fields (assign values or unknown)
      + LU - to match RaCA W- wetland, C- cropland, P- pastureland, F - Forestland, X- CRP, U added for unknown
  
_Master Horizons (M) set for each dataset in previous data management_
_Texture labels need to be assessed in ensure the same abbreviations are being used_
_wpg for ISCN needs to be converted to volumetric fragment content_


```{r dataPrep}

raca <- read.csv(paste0('RaCA_samples.csv'))

raca.loc <- read.csv('RaCA_xy.csv')

raca <- left_join(raca, raca.loc, by =c("rcasiteid" = "RaCA_site"))

raca$CALC_SOC <- ifelse(!is.na(raca$caco3),                      ifelse(raca$caco3>0,raca$c_tot_ncs-(raca$caco3*0.12),raca$c_tot_ncs), raca$c_tot_ncs)
raca$SOC <- ifelse(raca$CALC_SOC<0, 0, raca$CALC_SOC)
r <- raca[!is.na(raca$Measure_BD), c("samp", "upedon", "TOP", "BOT", "Model_desg", "M", "texture", "fragvolc", "SOC", "Measure_BD", "Model_BD", "LU", "Lat", "Lon")]
names(r) <- c("samp_id", "Pedon_ID", "Top", "Bottom", "Model_desg", "M", "Texture",  "CoarseFrag", "SOC", "BD", "RF.BD","LU","Lat", "Lon" )
r$SET <- "RaCA"
r$Clay <- NA



nwca <- read.csv('nwca.SOCsamples_5-10.csv')
nwca.loc <- read.csv('NWCA2011_SITEINFO_081315.csv')

nwca <- left_join(nwca, nwca.loc, by = "UID")

w <- nwca[!is.na(nwca$BD), c( "samp", "Pedon", "top", "bottom", "Model_desg" , "M", "TEXTURE_CLASS", "CLAY", "ROCK_FRAGMENTS", "SOC", "BD", "Model", "AA_CENTER_LAT", "AA_CENTER_LON")]
names(w) <- c("samp_id", "Pedon_ID" ,"Top", "Bottom", "Model_desg", "M", "Texture", "Clay", "CoarseFrag", "SOC", "BD", "RF.BD", "Lat", "Lon")
w$LU <- "W"
w$SET <- "NWCA"
w$Pedon_ID <- as.factor(w$Pedon_ID)

#combine dataset into one - missing values are filled with NA
combo <- rbind(r,w)

#there are a number of really high bulk density numbers - primarily in the ISCN set - need to investigate further
combo <- combo %>% filter(BD<2) 

#knitr::kable(n_M),digits = 1, col.names =names(n_S), caption = "Number of Samples in each Dataset", row.names =F, padding= 2)

```


##Compare Datasets
Use dplyr (with piping) to format and ggplot to create graphs

```{r graphs}
d <- combo %>%
  ggplot(aes(BD)) + geom_density(aes(fill = SET), alpha=.5) + scale_x_continuous(limits = c(0,3))+
  facet_wrap(~M) + ggtitle('Bulk density by Master Horizon')
d

b <- combo %>%
  #filter(!is.na(BD)) %>%
  ggplot(aes(y = BD, x=SET)) + geom_boxplot(aes(fill=LU)) +
  facet_wrap(~M) + ggtitle('Bulk density by Dataset and Land Use/Cover Class')
b

o <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = BD, x=SET)) + geom_boxplot(aes(fill=LU)) +
  ggtitle('For O (organic) horizons only \n Bulk density by Master Horizon and Land Use/Cover Class')
o

s <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = BD, x=SOC)) + geom_point(aes(color=LU, shape = SET)) +
  ggtitle('For O (organic) horizons only \n Bulk density and SOC')
s

S <- combo %>%
  filter(!is.na(BD) & M == "O") %>%
  ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=LU, shape = SET)) +
  ggtitle('For O (organic) horizons only \n Bulk density and SOC')
S

Sw <- combo %>%
  filter(!is.na(BD) & M == "O" & LU == "W") %>%
  ggplot(aes(y = 1/BD, x=SOC)) + geom_point(aes(color=SET, shape = SET)) +
  ggtitle('For O (organic) horizons in Wetlands only \n Bulk density and SOC')
Sw
```


```{r r-plots}

#joy plot with continuous fill
R <- combo %>%
      filter(!is.na(BD)) %>%
      ggplot(aes(x=BD, y = SET, fill = ..x..)) +  
    geom_joy_gradient()  + 
    scale_fill_gradientn(colours = cet_pal(5, name = "fire"), name = "BD")+
    theme_joy() +
    theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
    labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Ridgeplot of BD by Dataset")

R


#bee swarm
B <- combo %>%
      filter(!is.na(BD)) %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")

B

#add SOC measurement for visulaization
B_C <- combo %>%
      filter(!is.na(BD)&!is.na(SOC) ) %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis()+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")

B_C

#limit to organic horizons
#bee swarm
Bo <- combo %>%
      filter(!is.na(BD) & M =='O') %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of Organic Horizons \n by Dataset")

Bo

Bow <- combo %>%
      filter(!is.na(BD) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), name = "BD")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

Bow

#with SOC measurement
BoC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n by Dataset")

BoC

BowC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

BowC

BowCc <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W' & SOC>20) %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=14))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons with SOC > 20% \n in Wetlands by Dataset")

BowCc

BowT <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = Top)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "magma")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

BowT

BowTc <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W' & SOC > 20) %>%
  ggplot(aes(x=BD, y = SET, color = Top)) +  
  geom_quasirandom(alpha=0.5, groupOnX=FALSE) + 
  scale_color_viridis(option = "magma")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")

BowTc

#prep select graphs for export
B <- combo %>%
      filter(!is.na(BD)) %>%
  ggplot(aes(x=BD, y = SET, color = BD)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_gradientn(colours = cet_pal(10, name = "cyclic_mrybm_35-75_c68_n256"), guide = FALSE)+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
  #labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Beeswarm Plot of BD by Dataset")
 labs(x =expression(paste('Bulk Density (g cm'^-3,')')), y='Dataset')

B

# ggsave('BDswarm_all.png', plot = B, device = "png", path = 'C:/Users/skye.wills/ownCloud/AGU_BD-OMgraphs/poster', scale = 1, width = 6, height = 3, units = "in", dpi = 600, limitsize = TRUE)


BowC <- combo %>%
      filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
  ggplot(aes(x=BD, y = SET, color = SOC)) +  
  geom_quasirandom(alpha=0.82, groupOnX=FALSE) + 
  scale_color_viridis(option = "viridis")+
  theme_joy() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('Bulk Density (g cm'^-3,')')), y='Dataset', color = 'SOC (%)')

BowC



```


```{r SOCden}
Den <- combo %>%
  mutate(SOCden = BD*SOC/100) %>%    
  filter(!is.na(BD) &!is.na(SOC) & M =='O' & LU =='W') %>%
      
  ggplot(aes(x=SOCden, y = Top, color = SET)) +  geom_point(size =6, alpha = 0.5) +
theme_joy() + scale_y_reverse() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Top Depth (cm)', color = 'Dataset', title = 'Wetland field described O horizons')

Den

Den <- combo %>%
  mutate(SOCden = BD*SOC/100) %>%    
  filter(!is.na(BD) &!is.na(SOC) & M == "O" & LU == "W" ) %>%
      
  ggplot(aes(x=SOCden, y = Top, color = SET)) +  geom_point(size =6, alpha = 0.5) +
theme_joy() + scale_y_reverse() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Top Depth (cm)', color = 'Dataset', title = 'All horizons')

Den

Den1 <- combo %>%
  mutate(SOCden = BD*SOC/100) %>%    
  filter(!is.na(BD) &!is.na(SOC)) %>%
      
  ggplot(aes(x=SOCden, y = Top, color = SET)) +  geom_point(size =6, alpha = 0.5) +
theme_joy() + scale_y_reverse() +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title="Bulk Density of O Horizons \n in Wetlands by Dataset")
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Top Depth (cm)', color = 'Dataset', title = 'All horizons')

Den1


#

Den2 <- combo %>%
   filter(!is.na(BD) &!is.na(SOC)) %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = M), size =4, alpha = 0.5) + 
  geom_boxplot(color = "grey", alpha = 0.5)  +  
  theme_joy() +  scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(x =expression(paste('SOC Density (g cm'^-3,')')), y='Depth Class (cm)', color = 'Master Horizon', title = 'All horizons') +
  facet_wrap(~SET)

Den2

Den2O <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(color = "lightblue", size =4, alpha = 0.75) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Master Horizon', title = 'Organic horizons (field Described)') +
  facet_wrap(~SET)

Den2O

Den2Oc <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = SOCm), size =4, alpha = 0.95) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_color_gradient2(low = "dark blue", mid = "white", high = "green", midpoint = 20) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = '% SOC', title = 'Organic horizons, field described') +
  facet_wrap(~SET)

Den2Oc

Den2O

Den2Od <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = BDm), size =4, alpha = 0.95) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_color_gradient2(low = "black", mid = "white", high = "red", midpoint = 0.5) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Bulk Density \n g/cm3', title = 'Organic horizons, field described') +
  facet_wrap(~SET)

Den2Od

Den2OdW <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O"& LU =="W") %>%
  mutate(SOCden = BD*SOC/100) %>% 
   mutate(D = cut(Top, breaks = c(0,10,25,50,100), labels = c('0 - 10cm', '10 - 25cm','25 - 50cm', '50 - 100cm'))) %>%
  mutate(D = factor(D, levels = rev(levels(D))))%>%
    filter(!is.na(D)) %>% 
  group_by(samp_id, M, LU,SET,D )  %>%
  summarize(SD = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD)) %>%
 ggplot(sata= DD2, aes(y=SD, x =D)) +     geom_jitter(aes(color = BDm), size =4, alpha = 0.95) + 
  geom_boxplot(color = "grey", alpha = 0.75)  +  
  theme_joy() +  scale_color_gradient2(low = "black", mid = "white", high = "red", midpoint = 0.5) +    scale_y_continuous(limits = c(0,0.5) ) +coord_flip()  +
  theme(plot.caption=element_text(hjust=0,size=9),
        axis.title=element_text(size=12),
        plot.title=element_text(size=24))+
#labs(x="Bulk Density",y="Dataset",caption="@wills_skye", title = ' Carbon Density of all horizons)
 labs(y =expression(paste('SOC Density (g cm'^-3,')')), x='Depth Class (cm)', color = 'Bulk Density \n g/cm3', title = 'Organic horizons, field described, in Wetlands') +
  facet_wrap(~SET)

Den2OdW

#find samples that are high in OM, but also have high bulk density
sample_flag <- combo %>%
   filter(!is.na(BD) &!is.na(SOC) & M == "O"& LU =="W") %>%
  mutate(SOCden = BD*SOC/100) %>% 
  filter(SOC > 10, BD > 0.5) 


#find unique pedon id
Ped_flag <-  sample_flag %>%
  group_by(Pedon_ID) %>%
  summarize(SOCdenM = mean(SOCden, na.rm=T), SOCm  = mean(SOC), BDm = mean(BD),
            SDmax = max(SOCden), SOCmax =max(SOC), BDmax = max(BD))

raca_flag <- Ped_flag %>%
 right_join(raca %>% filter(!is.na(SOC)) %>% mutate(Pedon_ID = upedonid)) %>%
  filter(!is.na(SDmax))

raca_pedon_flag <- raca_flag %>%
  select(rcasiteid) %>%
  group_by(rcasiteid) %>%
  summarise()

```

##Locations
Summarize by pedons, select all wetlands and plot locations
How do we co-locate?


```{r loc}
library(png)
library(grid)

#one location per observation/pedon and clean lat/lon
C <- combo %>%
  filter(LU == "W" & Lat != 0) %>%
  select(SET, Pedon_ID, Lat, Lon, BD) %>%
  group_by(Pedon_ID) %>%
  mutate(Lat = ifelse(Lat == 0, NA, Lat), Lon = ifelse(Lon == 0, NA, Lon)) %>%
 summarize_all('min')
 
C_sp  <- C
  
#create spatial object 
names(C_sp) <- tolower(names(C_sp))
C_sp <- C_sp[complete.cases(C_sp),]

#xy cooridanates
coordinates(C_sp) <- ~ lon + lat
proj4string(C_sp) <- CRS("+proj=longlat +datum=WGS84")
C_sp <- spTransform(C_sp, CRS("+init=epsg:5070"))



us <- map("state", plot = FALSE)
us_sp <- {map2SpatialLines(us, proj4string = CRS("+init=epsg:4326")) ->.;
  spTransform(., CRS("+init=epsg:5070"))
}


#plot all
plot(C_sp, col = "lightgrey") # plot all points

#change color of NWCA points
setN <- C_sp$set =="NWCA"
plot(C_sp[setN, ], col = "turquoise") # add selected zones to map

#chang color of RACA points (wetlands)
plot(C_sp[C_sp$set =="RaCA", ], col = "grey")


plot(us_sp)

#=======
#spplot.points(C_sp)

####

cols <- brewer.pal(2, "RdYlBu")

C_sp$SET <- as.factor(C_sp$set)

plot(C_sp) 
plot(C_sp[C_sp$SET=='RaCA',])

par(mar=c(0,0,0,0))

map('state')
#points(C.sp, cex=0.5, pch=3, col='red'))


#mapview(C.sp)
 
```
use sf to create spatial stuff
``` {r spatial_sf}
library(sf)
# devtools::install_github("tidyverse/ggplot2")
# require(ggplot2)

Csf <- st_as_sf(
  C, 
  coords = c("Lon", "Lat"),
    crs = "+proj=longlat +datum=WGS84")

plot(Csf)

# NOt working 
# ggplot(Csf) + geom_sf(aes(color = SET))


plot(Csf['SET'])
plot(Csf['BD'])

```


#pairs to look into
uid - 4958 and RaCAsite C1606W04
uid - 4366 and RaCAsite C1201C08 (RI island?)
uid 4354 and 5211 and C1212W06 and C1206F04


#calculate SOC stocks
```{r Ped_stock, eval=T, warning = F, message = F, error = F }

#dataprep - label calculations with modeled BD
combo_pedcalc <- combo %>% mutate(BDmix = ifelse(!is.na(BD), BD, RF.BD), thick = Bottom - Top)

#SOCdensity
combo_pedcalc <- combo_pedcalc %>% mutate(SOCden = BD*SOC/100, SOCden_mix = BDmix*SOC/100, SOCden_MODEL = RF.BD*SOC/100) 


#SOC density with course fragments
  combo_pedcalc <- combo_pedcalc %>% mutate(SOCden_CF = SOC*BD*(1 - ifelse(CoarseFrag == 0, 0, CoarseFrag/100)),                                                                        SOCden_CF_MODEL = SOC*RF.BD*(1 - ifelse(CoarseFrag == 0, 0, CoarseFrag/100)),                                                               SOCden_CF_mix = SOC*BDmix*(1 - ifelse(CoarseFrag == 0, 0, CoarseFrag/100))
                                             )

  
  
  #assign how layers are counted in stock calculations
#puts a number on the amount (cm) of each layer used in calculation

  #old SOC_5 - the cm within each depth 
combo_pedcalc <-  combo_pedcalc %>% mutate(samp_in_5 = ifelse(Bottom <=5, thick, ifelse(Top,5, 5 - Top ))
  
# 
# samp$SOC_5 <- ifelse(samp$bottom<=5, samp$thick,ifelse(samp$top<5, 5-samp$top,0))
# 
# samp$SOC_30 <- ifelse(samp$bottom<=30, samp$thick,
#                     ifelse(samp$top<30, 30-samp$top,0))
# 
# samp$SOC_100 <- ifelse(samp$bottom<=100, samp$thick,
#                     ifelse(samp$top<100, 100-samp$top,0))
# 
# #calculate layer stocks - assigned depth * SOCden 
# #native units are Mg/ha
# samp$SOCstock5 <- with(samp, SOCden*SOC_5)
# samp$SOCstock30 <- with(samp, SOCden*SOC_30)
# samp$SOCstock100 <- with(samp, SOCden*SOC_100)
# 
# #sum SOC by pedon
# SOC_5 <- aggregate(SOCstock5~MO + MOGr + LU + MOGrLU + rcasiteid + upedonid + upedon, data=samp, FUN=sum)
# SOC_30 <- aggregate(SOCstock30~upedonid, data=samp, FUN=sum)
# SOC_100 <-aggregate(SOCstock100~upedonid, data=samp, FUN=sum) 
# 
# 
# #additional information about pedons used to screen for pedons that do not meet depth requirements
# #pedon id info
# ped <- aggregate(sample.id ~MO + MOGr + LU + MOGrLU + rcasiteid + upedonid + upedon, data=samp, FUN=length)
# names(ped)[8] <- "Sample_count"
# 
# #pedon information
# pedon_thick <- aggregate(thick  ~ upedonid, data=samp, FUN=sum)
# names(pedon_thick)[2] <- "total_thickness"
# ped_bott <- aggregate(bottom~upedonid, data=samp, FUN=max)
# lab_no <- aggregate(natural_key~upedonid, data=samp, FUN=length)
# names(lab_no)[2] <- "Lab_count"
# 
# sample_notR <- aggregate(sample.id~upedonid, data=samp[grep("R", samp$model_desg, invert=T, ignore.case=T),] , FUN=length)
# names(sample_notR)[2] <- "Non-R_SampleCount"
# 
# SOC_no <- aggregate(SOC~upedonid, data=samp[!is.na(samp$SOC), ], FUN=length)
# names(SOC_no)[2] <- "SOC_count"
# 
# SOC_thick <- aggregate(thick~upedonid, data=samp[!is.na(samp$SOC), ], FUN=sum)
# names(SOC_thick)[2] <- "SOC_thickness"
# 
# top <- aggregate(top~upedonid, data=samp, FUN=min)
# names(top)[2] <- "Pedon_top"
# 
# #depth of R or other restrictive layer (assumed to have negligble SOC at this depth and below)
# 
# hard <- c("Bkm", "Bkmm", "Bqm", "R", "Cr", "m")
# depthR <- aggregate(top~upedonid, data=samp[grepl(paste(hard, collapse='|'),  samp$model_desg, ignore.case=T),], FUN=min)
# names(depthR)[2] <- "Depth_to_R"
# 
# depth_O <- aggregate(thick~upedonid, data=samp[samp$M == "O",], FUN=min)
# names(depth_O)[2] <- "Depth_of_O"
# depth_O$Depth_of_O <- ifelse(is.na(depth_O$Depth_of_O), 0, depth_O$Depth_of_O)
# 
# #combine pedon information
# 
# SOC5 <- join(ped, SOC_5, by="upedonid", type="full", match="first")
# SOC30 <- join(SOC5, SOC_30, by="upedonid", type="full", match="first")
# SOC100 <- join(SOC30,SOC_100, by="upedonid", type="full", match="first")
# SOCp <- join(SOC100, pedon_thick, by="upedonid", type="full", match="first")
# SOCn <- join(SOCp, SOC_no, by="upedonid", type="full", match="first")
# SOCnn <- join(SOCn, lab_no, by="upedonid", type="full", match="first")
# SOCpn <- join(SOCnn, depthR, by="upedonid", type="full", match="first")
# SOCpp <- join(SOCpn, sample_notR, by="upedonid", type="full", match="first")
# SOCpo <- join(SOCpp, depth_O, by="upedonid", type="full", match="first")
# SOCpedons <- join(SOCpo, SOC_thick, by="upedonid", type="full", match="first")
# 
# #remove unneeded tables
# rm(SOC5,SOC30, SOC100, SOCp, SOCn, SOCnn, SOCpp, SOCpo)
# 
#                                                       
# SOCpedons$USE <-ifelse(SOCpedons$SOCstock5 == 0, 
#                                                 ifelse(SOCpedons$SOC_count<SOCpedons$Lab_count,"MISS_anal", "MISS_labsamp"), 
#                        ifelse(is.na(SOCpedons$total_thickness), 'NA',
#                               ifelse(SOCpedons$SOC_thickness >= SOCpedons$total_thickness, '100',
#                                      ifelse(!is.na(SOCpedons$Depth_to_R),  
#                                             ifelse(SOCpedons$Depth_to_R <= SOCpedons$SOC_thickness , '100', 
#                                                    ifelse(SOCpedons$SOC_thickness >= 100, '100',
#                                                           ifelse(SOCpedons$SOC_thickness >= 30, '30',
#                                                                  ifelse(SOCpedons$SOC_thickness >= 5, '5', 'NA')))),
#                                             ifelse(SOCpedons$SOC_thickness >= 100, '100',
#                                                    ifelse(SOCpedons$SOC_thickness >= 30, '30',
#                                                           ifelse(SOCpedons$SOC_thickness >= 5, '5', 'NA'))))
#                               )))
#                         
# 
# # check NAs and missing samples
# kable( table(SOCpedons$MO,SOCpedons$USE, useNA= "ifany"), caption = "Table S2. Counts of missing samples by depth")
# Use.pedons <- ddply(SOCpedons, .(MO), summarise, 
#                           N_5= sum(!is.na(SOCstock5)),
#                           N_30= sum(!is.na(SOCstock30)),
#                           N_100= sum(!is.na(SOCstock100))
# )
# 
# #kable(Use.pedons, caption = "Count of Pedons with all SOC Data")
#   
# 
# #keep ones with values
# SOCpedons <- SOCpedons[!is.na(SOCpedons$SOCstock5),]
# SOCpedons <- SOCpedons[SOCpedons$SOCstock5 != 0,]
# 
# #remove stocks based on Use field 
# SOCpedons$SOCstock5 <- as.numeric(ifelse(SOCpedons$USE %in% c(5, 30, 100), SOCpedons$SOCstock5, ""))
# SOCpedons$SOCstock30 <- as.numeric(ifelse(SOCpedons$USE %in% c(30, 100), SOCpedons$SOCstock30, ""))
# SOCpedons$SOCstock100 <- as.numeric(ifelse(SOCpedons$USE %in% c(100), SOCpedons$SOCstock100, ""))
# 
# #limit pedon file to those that have useable data
# SOCpedons <- SOCpedons[!is.na(SOCpedons$USE),]
# 
# #remove unwanted objects
# rm(hard, depth_O, depthR, lab_no,ped, ped_bott, pedon_thick, sample_notR, SOC_thick, SOC_100, SOC_30, SOC_5, SOC_no, SOCpn, top )
# 
# #export pedon (site) level SOC stocks
# #############
# write.table(SOCpedons,"RaCA_SOC_pedons.csv", sep=",", row.names=F)

```
  