```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(aqp)
library(soilDB)
library(plyr)
library(ggplot2)
library(reshape2)
library(stringr)
library(knitr)
```

---
title: "Digital summaries of legacy pedon descriptions"
author: "Stephen Roecker, Dylan Beaudette, Jay Skovlin, Skye Wills"
output:
  word_document:
    fig_caption: yes
fig_caption: yes
---

# Abstract

Soil scientists have been collecting field and lab pedon descriptions for over a hundred years. Within the United States a small portion of this data has been captured in the National Soil Information System (NASIS). While NASIS serves as a superb data repository, its analytical capabilities are limited, and thus we believe it's data is underutilized. Therefore we advocate the use of R, which can easily import data from NASIS and has custom functions designed for digital soil morphometrics. In conjunction with the Western Regional Cooperative Soil Survey Technology Committee we have developed html reports that provide standardized summaries and graphics of data commonly used for soil survey activities, such as the Soil Data Join and Recorrelation initiative, development of Official Series Descriptions and soil components, development of soil map units, and competing dissimilar soils. With little prior knowledge even R novices can quickly generate their own results. Examples can be viewed at, https://github.com/ncss-tech/soil-pit/tree/master/examples, where development is on-going.

# Introduction

In support of developing soil surveys over the last 100 years the National Cooperative Soil Survey (NCSS) has amassed a substantial amount of legacy pedon data. This data consists of field estimates, observations, and laboratory measurements. Unlike the soil map layers and their associated attribute data (component data), pedon data represent unaggregated data from individual observations of soils on the landscape. This makes pedon data an invaluable resource for future updates to existing soil surveys. Currently such updates to the aggregated component data have been taking place on a national scale as part of the Soil Data Join and Recorrelation (SDJR) initiative since 2012 (NI_403_305, 2013). In the future additional updates are planned for the spatial data. 

Since the introduction of the National Soil Information System (NASIS) in 1994, approximately 606,595 field pedons and approximately 63,000 lab pedons have been digitized. While significant this represents only a small portion of total field pedons ever described. In addition, it is speculated that the real number is approximately 30 percent less, more like 400,000 pedons, due to duplicate records and placeholders in the NASIS database (Ferguson, 2015). The ambiguity in this number reflects the view that pedon data is considered supporting data, and thus is not subjected to more rigorous review performed on the component data which is distributed to the public in combination with soil map spatial data layers.

```{r, echo=FALSE, warning=FALSE}

pedons <- c(577, 6152, 9517, 19058, 42587, 112182, 231609, 184913)
year <- c("<1950s", "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s")

ggplot(data.frame(pedons, year), aes(x=year, y=pedons)) + geom_bar(stat="identity")

# There has been lots of talk about the number or Soil Series, Components, Map units, etc... but little focus on the point data resource.
# Lots of talk about collecting new data, but little appreciation for existing data.
```

In order to store soil data NASIS has a complex hierarchical data structure, with soil horizons and associated characteristics being the most basic element. Nested within each horizon record are additional child tables that are linked to the horizon record. Each of these child tables, may include several related child tables to capture heterogeneous soil conditions within each soil horizon. The dominant condition specified as the representative value (RV). For numeric component data it is possible to specify a range with a Low (L) and High (H) values. This makes it possible to characterize the distribution or uncertainty of a particular soil variable, such as clay content. Using this system it is then possible to capture complex soil horizonation, aggregate the data, and then generate spatial predictions by linking to the soil polygon layer.

![alt text](figures/nasis.png)

A fundamental and complicated step in the mapping process involves aggregating numerous horizon descriptions from field and lab pedons into component horizon data. Historically this process of determining the ranges (L, RV, H) for various soil attributes has been done with pencil and paper. A practice that still continues today for a variety of reasons, including:

    1. familiarity with existing protocol
    2. perceived or real software limitations
    3. inconsistency among the existing data
    4. large additional workload involved in digitizing data
    5. lack of training in new software

While it is possible to manipulate pedon data directly in NASIS, however, the majority of existing functions within NASIS have been designed to analyze and evaluate component-level aggregate data. It possible to export data from NASIS to other software, but none of the alternatives provide the same concise summary of data as do the standardized reports for component data in NASIS. New reports could be added to NASIS, but complex reports are very difficult to write because NASIS currently supports a limited implementation of the Structured Query Language (SQL) which has a limited range of functions for performing statistical analysis. Exporting pedon data to R (R Core Development Team, 2015) allows the NCSS to leverage numerous base functions designed for organizing and analyzing data, new report writing capability (Xie, 2014), and user contributed functions specifically designed for digital soil morphometrics, such as the aqp (Beaudette et al., 2012), soilDB (Beaudette and Skovlin, 2015), and soiltexture (Moeys, 2015) packages.

## Tools for interacting with soil data
### Tabular analysis
    1. Pencil and paper
    2. Excel spreadsheets
    3. PedonPC and AnalysisPC (Microsoft Access databases) 
    4. NASIS
    5. R

### Spatial analysis
    1. SoilWeb
    2. Web Soil Survey
    3. Soil Data Viewer
    4. SSURGO file geodatabases
    5. R
_* sorted by sophistication_

# Methods - R

RStudio, an Integrated Development Environment (IDE) for R, is used to generate summary reports in R. It provides a minimalist Graphical User Interface (GUI) that parses the R environment into task oriented windows. The initial start up process of using RStudio and R to run the reports requires the user to install several R packages and their dependencies (Roecker, 2015), and setup an ODBC connection to NASIS (Beaudette, 2015). These steps are fully documented online, and readers are pointed to these reference documents for full details. R is a highly extendable environment, and is in dynamic development, so installing additional packages is a common place practice as packages are updated or new packages become available. 

Prior to aggregating the horizons it is necessary to develop a table of generalized horizon labels (GHL) to specify which horizons are similar enough to be aggregated. This is accomplished by mapping the existing horizon designations for each horizon, and matching them to a generalized (i.e. simplified) horizonation sequence for each soil series or component. The assumption is made that the existing horizon designations accurately reflect the soil morphology and the corresponding soil properties of the horizons. For established soil series, the Official Series Description (OSD) can be used as a starting point for determining the appropriate GHL to assign to the horizons for the soil in question. The OSD provides a sample of likely horizon designations within either the typical pedon described or the Range of Characteristics (RIC) sections. For example, Bw and Btk horizons might be aggregated if the development of the Btk horizon is incipient and doesn't meet the definition of an argillic or calcic diagnostic horizon. Another approach is to simply examine the frequency with which each HD occurs. HD that occur frequently are likely to be the most representative. Lastly it maybe useful to graphically examine uni-variate or multivariate summaries of each horizon (Beaudette and Skovlin, 2015). 

![alt text](figures/genhz-sketch.png)
# TODO: insert a caption for figure and adjust formatting on the table

```{r sort-hz-by-freq-print-html, echo=FALSE, results='asis'}

data(loafercreek, package = 'soilDB')
pedons <- loafercreek
counts <- rbind(sort(table(pedons$hzname), decreasing=TRUE))
kable(as.data.frame.matrix(counts)[1:12])
```

Once appropriate GHL have been determined for the collection of pedons, pattern matching is used to assign the new GHL to each horizon. The process uses functions designed to parse the text from each horizon designation, and match it to the new generalized horizon designation. the function searches for any combination of characters before or after the specified pattern. Special meta-characters serve as anchors or anti-wildcards for the beginning (i.e. caret "^"), and end (i.e. dollar sign "\$") of the given pattern. For example, the GHL pattern rule "Bt" will match any permutation of Bt, such 2Bt or Bt1. To exclude 2Bt horizons, a more specific pattern of "^Bt" would be necessary. Conversely, to exclude Bt1 horizons, a pattern of "Bt\$" would be used. The GHL rules information is stored in a text file as it is developed, and then referenced by the report script. If the user is satisfied with the resulting GHL designations, they can upload it to the comp layer id field in the horizon table in NASIS where it is stored for future use.

- GHL and rules for the aqp loafercreek sample data-set:
  - **A**: `^A$|Ad|Ap`
  - **Bt1**: `Bt1$`
  - **Bt2**: `^Bt2$`
  - **Bt3**: `^Bt3|^Bt4|CBt$|BCt$|2Bt|2CB$|^C$`
  - **Cr**: `Cr`
  - **R**: `R`
  
In order to fetch NASIS data for use in R, a user must first load a selected set of pedon and lab data in NASIS. A selected set is a view or virtual table that is created via a query, and serves as a working subset of a user's local NASIS database. NASIS has numerous queries to accomplish this. Once the data is loaded in NASIS, it can be brought into R via ODBC connection using the fetchNASIS() function in the soilDB package.  The user needs to modify the report script by entering the name of the text file (e.g. "Miami") containing the GHL rules that correspond to the pedons loaded into the selected set.  The report script is run and the html output is generated by pressing the Knit button in RStudio. The necessary analysis steps are programmed into the report script and the output is formatted to html using R Markdown (Rmd).

# Results

The resulting field and lab pedon reports contains much of the information typically used to summarize data for developing Official Series Descriptions (OSD) and aggregated mapunit soil components, and competing dissimilar soils. Embedded in the reports are a mixture of tables and graphics. Numerical values are summarized using percentiles (i.e. quantiles), while categorical values are summarized by frequency tables (i.e. contingency tables). The percentiles used in the report can be adjusted by the user, but default is set to the five number summary (0%, 25%, 50% or median, 75%, 100%). Additionally, the percentiles are appended with the number of observations (e.g. (1, 2, 3, 4, 5)(5)), to inform the user of the sample size. The standard graphics used are box plots which are similar to the five number summary (outliers, ~5%, ~25%, 50% or median, ~75%, ~95%, outliers).

Evaluating the report graphics and tables quickly shows where there are possible errors, narrow or wide ranges in values or data gaps due to insufficient data.


# Discussion

What did you learn? "Alfred"

- we have a wealth of existing data
- data on soil series should be viewed in aggregate
- "we shouldn't let the perfect be the enemy of the good"
- reproducible research is good
- Soil Departments should teach Statistics!!! Soil students are rarely taught how to analyze soil in its three dimensional nature.
- Soil scientists are great at collecting data, but we have to just as good at analyzing it.

## Summary or report workflow
    0. Setup ODBC connection and install additional packages
    1. Develop and assign a generalized horizonation label (GHL)
    2. Generate report and evaluate

# Conclusion

Soil profile descriptions within the NASIS database represent a significant body of observations within the NCSS of the United States.  This data was collected over many years and represents an immense body of observations and knowledge of the local soil properties.  From an organizational perspective the data can often be difficult to use and summarize. Using the relational structure of the NASIS database combined with the extensible data handling and statistical analysis capabilities of R, it is possible to generate powerful graphical and tabular summaries for collections of pedon data.  The scripting environment in R allows many data handling, statistical, and summarization processes to be bundled into one report.  The assignment of GHL in correlating similar horizon designations for summary is a fundamental step in this process and both requires and is informed through the expert knowledge of soil scientists.  Graphical displays of soil data continue to expand in capability within R making it a useful platform for generating reports summarizing pedon data.


# References
R Development Core Team, 2015.R:A Language and Environment for 
  Statistical Computing. R Foundation for Statistical Computing
  . Vienna, Austria. ISBN3-900051-07-0.

Beaudette, D.E., Roudier P., and A.T. O'Geen. Algorithms for
  Quantitative Pedology: A Toolkit for Soil Scientists. 2012

D.E. Beaudette and J.M. Skovlin (2015)a. soilDB: Soil Database
  Interface. R package version 1.5-2.
  HTTP://CRAN.R-project.org/package=soilDB
  
D.E. Beaudette and J.M. Skovlin (2015)b. Assigning Generalized Horizon Labels https://r-forge.r-project.org/scm/viewvc.php/*checkout*/docs/aqp/gen-hz-assignment.html?root=aqp

Beaudette, D.E., 2015. Setup an ODBC Connection to the Local NASIS Database. https://r-forge.r-project.org/scm/viewvc.php/*checkout*/docs/soilDB/setup_local_nasis.html?root=aqp

Julien Moeys (2015). soiltexture: Functions for Soil Texture Plot,
  Classification and Transformation. R package version 1.3.3.
  HTTP://CRAN.R-project.org/package=soiltexture

Yihui Xie (2014) knitr: A Comprehensive Tool for Reproducible
  Research in R. In Victoria Stodden, Friedrich Leisch and Roger D.
  Peng, editors, Implementing Reproducible Computational Research.
  Chapman and Hall/CRC. ISBN 978-1466561595
