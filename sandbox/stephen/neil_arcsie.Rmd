---
title: "Analysis of 11-FIN ArcSIE Erosion Classes"
author: "Stephen Roecker"
date: "November 7, 2016"
output: 
  html_document: 
    keep_md: yes
---


```{r, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```


## Setup

```{r setup}
library(aqp)
library(lattice)
library(latticeExtra)
library(ggplot2)
library(reshape2)
library(cluster)
library(caret)
library(party)
library(vegan)
library(RColorBrewer)
library(gridExtra)

options(stringsAsFactors = FALSE)
```

## Import Data and Transform

```{r read and tranform}

data <- read.csv("C:/workspace/neil_arcsie/Pedon_Data_DumpSIE.csv")

names(data) <- gsub(" ", "", names(data))
names(data) <- gsub("\\.", "", names(data))
data <- transform(data,
                  EroClassFD = as.factor(EroClassFD),
                  EroClassSIE = as.factor(EroClassSIE),
                  hzthk = hzdepb - hzdept,
                  rgb = munsell2rgb(mxhue, mxvalue, mxchroma, return_triplets = TRUE)
                  )
```


## Confusion Matrix of the Erosion Class vs the ArcSIE Predictions

```{r analyze}

cm <- confusionMatrix(data = data$EroClassSIE, reference = data$EroClassFD)

cm$table
cm$overall
```

The overall accuracy of the ArcSIE predictions is `r round(cm$overall[1], 2)`. The confusion matrix above shows that the ArcSIE model wasn't able to discriminate EroClassFD class 2 well. However since the initial sampling, Tonie Endres has reviewed some of the misclassifications and determined the ArcSIE classes to be correct, thus the overall accuracy is somewhat higher.


## Boxplots of the Erosion Classes

```{r EroClassFD boxplots}
vals <- c("hzthk", "SolumDp", "CaCO3Dp", "claytotest", "SurfFrags", "mxvalue", "mxchroma", "SlopeSIE", "ProfCrv", "PlanCrv")
data_lo1 <- melt(data, id.vars = "EroClassFD", measure.vars = vals)
data_lo2 <- melt(data, id.vars = "EroClassSIE", measure.vars = vals)

names(data_lo1)[1] <- "EroClass"
data_lo1 <- transform(data_lo1, method = "FD")
names(data_lo2)[1] <- "EroClass"
data_lo2 <- transform(data_lo2, method = "SIE")
data_lo <- rbind(data_lo1, data_lo2)


bwplot(EroClass ~ value | variable + method, data = data_lo, 
       scales = list(x ="free"), as.table = TRUE, layout = c(5, 4)
       )

# ggplot(data_lo, aes(x = EroClass, y = value)) +
#   geom_boxplot() +
#   facet_wrap(~ variable + method, scales="free_y")
```

The box plots show that the FD erosion classes have a linear trend for some variables, while others only show one class deviating from the others. In addition the variation within each classes overlap the others, such that their median values are indistinguishable from the other classes in many cases. The trends for the EroClassSIE classes appear to be less linear and have less separation. 


## Scatterplots of the Erosion Classes

```{r mda}
soil_vals <- c("hzthk", "SolumDp", "CaCO3Dp", "claytotest", "SurfFrags") # excluded color, only observed a narrow range thus small differences swamp everthing else
geo_vals <- c("SlopeSIE", "ProfCrv", "PlanCrv")
vals <- c(soil_vals, geo_vals)

test <- subset(data, select = vals)
test_d <- daisy(scale(test), metric = "gower")
test_mds <- metaMDS(test_d, distance = "gower", autotransform = FALSE)
test_pts <- cbind(as.data.frame(test_mds$points), EroClassFD = data$EroClassFD)

opar <- trellis.par.get()
trellis.par.set(ggplot2like(n = 4, h.start = 180))
tpg <- trellis.par.get("superpose.symbol")
tpg$cex <-  1.5
trellis.par.set("superpose.symbol", tpg)

p1 <- xyplot(hzthk ~ SolumDp, groups = data$EroClassFD, data = data, 
             type = c("g", "p"), aspect = 1,
             auto.key = list(space = "right")
             )
p2 <- xyplot(MDS2 ~ MDS1, groups = test_pts$EroClassFD, data = test_pts,
             type = c("g", "p"), aspect = 1,
             auto.key = list(space = "right"),
             )
plot(p1, split = c(1, 1, 2, 1))
plot(p2, split = c(2, 1, 2, 1), newpage = FALSE)


# p1 <- ggplot(data, aes(x = hzthk, y = SolumDp,  col = EroClassFD)) +
#   geom_point(cex = 3) +
#   theme(aspect.ratio = 1)
# p2 <- ggplot(test_pts, aes(x = MDS1, y = MDS2, col = EroClassFD)) +
#   geom_point(cex = 3) +
#   theme(aspect.ratio = 1)
# grid.arrange(p1, p2, ncol = 2)
```

The scatter plots of the erosion classes displayed over various dimensions, including using multidimensional (MD) scaling, again show their is overlap between the erosion classes. 


## Cluster Analysis

```{r ca}
test_c <- hclust(test_d, method = "ward")
plot(test_c, labels = data$upedonid)
rect.hclust(test_c, k = 3)
```

Example of Centerburg data classified using a hierarchical cluster analysis, and aggregated into the 3 most distinct classes. The 3rd class appears to be an outlier.


## Contingency Table of the Erosion Classes vs the Hierachical Clusters

```{r}
clusters <- cbind(data, test_pts, clusters = as.factor(cutree(test_c, k = 3)))

with(clusters, table(EroClassFD, clusters))
with(clusters, table(EroClassSIE, clusters))
```

The contingency table shows that the field determined erosion classes (EroClassFD) 1 and 2 overlap the most with the hierarchical clusters 2 and 3. The ArcSIE predictions don't appear to have as much correspondence with the hierarchical clusters.


## Scatter Plots of the Erosion Classes vs the Hierachical Clusters

```{r}
p1 <- ggplot(clusters, aes(x = MDS1, y = MDS2, col = EroClassFD)) +
  geom_point(cex = 3) +
  theme(aspect.ratio = 1)
p2 <- ggplot(clusters, aes(x = MDS1, y = MDS2, col = clusters), main = "test") +
  geom_point(cex = 3) + 
  theme(aspect.ratio = 1)
grid.arrange(p1, p2, ncol = 2)
```

The hierarchical clusters seem to have less overlap when viewed along the multidimensional scaled axes.


## Box Plots fo the Erosion Classes vs the Hierachical Clusters

```{r, fig.height=10}
vals <- c("claytotest", "CaCO3Dp", "SurfFrags", "hzthk", "SolumDp", "PlanCrv", "ProfCrv", "SlopeSIE", "mxvalue", "mxchroma")

data_lo1 <- melt(data, id.vars = "EroClassFD", measure.vars = vals)
names(data_lo1)[1] <- "EroClass"
data_lo1 <- transform(data_lo1, method = "FD")

data_lo2 <- melt(clusters, id.vars = "clusters", measure.vars = vals)
names(data_lo2)[1] <- "EroClass"
data_lo2 <- transform(data_lo2, method = "clusters")

data_lo <- rbind(subset(data_lo1, as.character(variable) %in% vals), data_lo2)

trellis.par.set(opar)

bwplot(EroClass ~ value | variable + method, data = data_lo, 
       scales = list(x ="free"), as.table = TRUE, layout = c(5, 4)
       )

# ggplot(data_lo, aes(x = EroClass, y = value)) +
#   geom_boxplot() +
#   facet_wrap(~ variable + method, scales="free_y", ncol = 2)
```

Back to back the erosion classes and hierarchical clusters show a similarly degree of separability. As observed early cluster 3 seems be an outlier, which a deeper solum (SolumDP) and depth to carbonates (CaCO3Dp).


```{r pca}
## Principal Component Analysis (PCA)

data_na <- na.exclude(data)
test <- subset(data_na, select = vals)
test_pc <- princomp(test, cor = TRUE)
```


## Classification Trees

```{r tree}
clusters <- subset(clusters, !is.na(EroClassFD))

test1 <- ctree(EroClassFD ~ ., data = clusters[, c("EroClassFD", soil_vals)])
plot(test1)
cm1 <- confusionMatrix(data = predict(test1, type = "response"), reference = clusters$EroClassFD)
cm1$table
cm1$overall
```

The classification tree of erosion classes using only soil variables as predictors shows that we can only separate the classes on horizon thickness (hzthk) using a break of 21-cm, which gives an overall accuracy of `r cm1$overall[1]`. The bar plots for node 2, shows that it more impure than node 3. 


```{r}
test2 <- ctree(clusters ~ ., data = clusters[, c("clusters", soil_vals)])
plot(test2)
cm2 <- confusionMatrix(data = predict(test2, type = "response"), reference = clusters$clusters)
cm2$table
round(cm2$overall, 2)
```

The classification tree for the hierachical clusters using only soil variables as predictors has an overall accuracy of `r cm2$overall[1]`, and is split on solum depth (SolumDp) and surface fragments (SurfFrags).


```{r}
test <- ctree(EroClassFD ~ ., data = clusters[, c("EroClassFD", geo_vals)])
plot(test)
cm2 <- confusionMatrix(data = predict(test, type = "response"), reference = clusters$EroClassFD)
cm2$table
cm2$overall
```

The classification tree of the erosion classes using the 

```{r}
test <- ctree(clusters ~ ., data = clusters[, c("clusters", geo_vals)])
plot(test)
cm3 <- confusionMatrix(data = predict(test, type = "response"), reference = clusters$clusters)
cm3$table
cm3$overall
```

## Summary

