# Report of changes requiring SSURGO recertification

```{r, echo=FALSE, warning=FALSE}
# These figures don't compare with Alena's spreadsheets. Her spreadsheets have additional counties that aren't captured in the Project Record.

options(stringsAsFactors=F)

library(foreign)
library(knitr)
library(plyr)
library(stringr)
library(RCurl)
library(XML)

source("C:/workspace/soil-pit/trunk/queries/kssl_reports.R")

data(state)

# WEB-MLRA_Goals_Progress

# goals <- goals_report(2015, "11-%25")
goals <- read.csv("C:/workspace/report_goals_2015_08_11.csv")

goals <- subset(goals, SS_Office != "")

kable(ddply(goals, .(SS_Office), summarise, n = length(unique(Project_Name))), caption = "Number or SDJR projects per SS Office")
```

```{r, summarize geodatabase tabular changes, echo=FALSE, cache=TRUE, warning=FALSE, message=FALSE, results='asis'}
# This assumes no changes have been made to the ORIG columns, could run a check against an unedited copy. Need to add addition scripts to see if the number of MUSYM edited = the total number of MUSYM.

# Digitizing unit report (proposed spatial changes in NASIS)
fy <- 2015

# du <- du_report(fy)
du <- read.csv("C:/workspace/report_digitizing_unit_2015_08_11.csv")

du11 <- subset(du, State_Responsible == "Indiana")

du11_np <- ddply(du11, .(Office), summarize, n_projects = length(unique(Project_Name)))
kable(du11_np, caption = "Number of proposed spatial changes")


# Correlation report (completed spatial changes in NASIS)
data(state)
st <- tolower(state.abb)
st_p <- paste0(st, "%25")

# corr <- correlation_report(st_p, 2015)
corr <- read.csv("C:/workspace/report_correlation_2015_08_11.csv")
corr$region <- unlist(lapply(corr$Office, function(x) strsplit(x, "-")[[1]][1]))
corr$ssa_musym <- paste0(corr$Area_Symbol, "_", corr$New_Symbol)

corr11 <- subset(corr, grepl("11-WAV", Office))

corr11_np <- ddply(corr11, .(Office), summarize, n_projects = length(unique(Project_Name)))
kable(corr11_np, caption = "Number of completed spatial changes")

corr_check <- ddply(corr11, .(Office, pname = abbreviate(Project_Name, 50), ssa_musym, musym_corr = New_Symbol), summarize, old_musym_corr = paste(unique(Old_Musym), collapse = ", ")) # project by natmusym and musym
kable(corr_check, caption = "NASIS spatial correlation legend by area symbol")


# Geodatabase report (completed spatial changes in geodatabase)
mupolygon <- read.csv("M:/geodata/project_data/11WAV/mupolygon_edit.csv")

id <- (mupolygon$Editor_Field != "" | mupolygon$MUSYM != mupolygon$ORIG_MUSYM) & mupolygon$ORIG_MUSYM != ""
edit <- mupolygon[id, ]
edit$ssa_musym <- paste0(edit$AREASYMBOL, "_", edit$MUSYM)

geo_check <- ddply(edit, .(ssa_musym, AREASYMBOL, musym_geo = MUSYM), summarise, old_musym_geo = paste(unique(ORIG_MUSYM), collapse=", "), n_polygons = length(ORIG_MUSYM), acres = round(sum(Shape_Area*0.000247), 0))

kable(geo_check, caption="Summary of changes to the RTSD geodatabase by Soil Survey Area")
```

```{r, checks}
# Checks
check1 <- join(corr_check, geo_check, by="ssa_musym", type = "full") # match geo_check to corr_check
kable(check1) # Matches between the RTSD geodatabase to the digitizing unit report

id <- match(corr_check$ssa_musym, geo_check$ssa_musym, incomparables=TRUE)
corr_mis <- unique(corr_check$ssa_musym[is.na(id)]) # natmusym missing from geodatabase
corr_mis # ssa_musym present in NASIS, but missing from the geodatabase
length(corr_mis) # number of missing ssa_musym

id <- match(geo_check$ssa_musym, corr_check$ssa_musym, incomparables=TRUE)
geo_mis <- unique(geo_check$ssa_musym[is.na(id)]) # ssa_musym missing from geodatabase
geo_mis # ssa_musym present in the geodatabase, but missing from NASIS
length(geo_mis) # number of missing natmusym
```
