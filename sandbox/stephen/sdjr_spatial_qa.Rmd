# Report of changes requiring SSURGO recertification

```{r, echo=FALSE, warning=FALSE}
# These figures don't compare with Alena's spreadsheets. Her spreadsheets have additional counties that aren't captured in the Project Record.
# This assumes no changes have been made to the ORIG columns, could run Alena's qa against an unedited copy.

options(stringsAsFactors = F)
source("C:/workspace/soil-pit/trunk/queries/kssl_reports.R")

library(foreign)
library(knitr)
library(plyr)
library(stringr)
library(RCurl)
library(XML)


SS_Office <- "11-GAL"
fy <- 2015
R_Office <- 10
mupolygon <- read.dbf("M:/geodata/project_data/11WAV/mupolygon_edits_from_Region10.dbf", as.is = TRUE)


data(state)
st <- paste0(tolower(state.abb), "%25")
st <- paste0(toupper(c("ia", "il", "in", "ks", "ky", "mi", "mn", "mo", "ne", "oh", "ok", "sd", "wi")), "%25")

# goals <- goals_report(fy, paste0(R_Office, "-%25"))
goals <- read.csv("C:/workspace/report_goals_2015_09_02.csv")
# du <- du_report(fy)
du <- read.csv("C:/workspace/report_digitizing_unit_2015_09_03.csv")

# corr <- correlation_report(st, 2015)
corr <- read.csv("C:/workspace/report_correlation_2015_09_03_spatial.csv")

region <- read.csv("M:/geodata/soils/SSA_Regional_Ownership_MASTER_MLRA_OFFICE.txt")

# leg <- legends_report(st)
leg <- read.csv("C:/workspace/report_legends_2015_09_03.csv")

```


```{r, summarize geodatabase tabular changes, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

# WEB-MLRA_Goals_Progress

goals <- subset(goals, SS_Office != "" & grepl(paste0(R_Office, "-"), SS_Office))
goals_np <- ddply(goals, .(SS_Office), summarise, n_projects = length(unique(Project_Name)), goaled = sum(Goaled), claimed = sum(Reported))
kable(goals_np, caption = "Number or SDJR projects per SS Office")


# Digitizing unit report (proposed spatial changes in NASIS)

du_r <- subset(du, State_Responsible == "Indiana")
du_r_np <- ddply(du_r, .(Office), summarize, n_projects = length(unique(Project_Name)))
kable(du_r_np, caption = "Number of proposed spatial changes")


# Correlation report (completed spatial changes in NASIS)

corr <- rename(corr, c("Area_Symbol" = "AREASYMBOL", "Project_Name" = "pname", "New_Symbol" = "musym", "Old_Musym2" = "old_musym"))

corr_r <- subset(corr, region == R_Office)
corr_r_np <- ddply(corr_r, .(Office), summarize, n_projects = length(unique(pname)))
kable(corr_r_np, caption = "Number of completed spatial changes")

# corr_r <- subset(corr, Office == SS_Office)
nasis_qa <- ddply(corr_r, .(Office, pname, AREASYMBOL, musym), summarize, n_old_musym = length(unique(old_musym)), old_musym = paste0(unique(old_musym), collapse=", ")) # project by natmusym and musym
nasis_qa2 <- ddply(nasis_qa, .(Office, pname, AREASYMBOL, musym, n_old_musym), summarize, old_musym = strsplit(old_musym, ", ")[[1]])


# Geodatabase report (completed spatial changes in geodatabase)

mupolygon <- rename(mupolygon, c("MUSYM" = "musym", "ORIG_MUSYM" = "old_musym"))
id <- (mupolygon$musym != mupolygon$old_musym & mupolygon$old_musym != "") | mupolygon$Editor_Fie != ""
edit <- mupolygon[id, ]

geo_qa <- ddply(edit, .(AREASYMBOL, musym), summarise, n_polygons = length(old_musym), acres = round(sum(Shape_Area*0.000247), 0), n_old_musym = length(unique(old_musym)), old_musym_geo = paste0(unique(old_musym), collapse=", "))
geo_qa2 <- ddply(geo_qa, .(AREASYMBOL, musym, n_polygons, acres, n_old_musym), summarize, old_musym = strsplit(old_musym_geo, ", ")[[1]])
write.csv(geo_qa, paste0("C:/workspace/report_spatial_geo_qa_", SS_Office, "_", format(Sys.time(), "%Y_%m_%d"), ".csv"))

```

```{r, QA checks, echo=FALSE}
# QA checks
key <- c("AREASYMBOL", "musym", "old_musym")
qa <- merge(nasis_qa2, geo_qa2, by = key, all = TRUE) # match geo_qa2 to nasis_qa2
# qa <- join(nasis_qa2, geo_qa2, by = key, type = "full") # match geo_qa2 to nasis_qa2

leg_key <- with(leg, paste0(mapunit_symbol, "_", area_symbol))
qa_key <- with(qa, paste0(musym, "_", AREASYMBOL))

qa$match <- with(qa, musym == old_musym)
qa$in_legend <- qa_key %in% leg_key
qa$in_project <- !is.na(qa$pname)
qa$in_geodatabase <- is.na(qa$pname)

qa0 <- qa[apply(is.na(qa), 1, any), ]
qa0 <- qa0[qa0$match == FALSE, ] # remove where musym = old musym

qa1 <- qa0[qa0$in_project == TRUE, ]
qa2 <- qa0[qa0$in_geodatabase == TRUE, ]
qa3 <- qa0[qa0$in_legend == FALSE, ]

# kable(qa1, caption = "NASIS changes missing from the geodatabase")
print("Missing values (NA) need to be either added/removed from NASIS or the RTSD geodatabase, Otherwise they maybe splits that need to be relinked to a new additional mapunit.")

kable(qa2, caption = "Geodatabase changes missing from NASIS")
print("Missing values (NA) need to be either added/removed from NASIS or the RTSD geodatabase, Otherwise they maybe splits that need to be relinked to a new additional mapunit.")

# kable(qa3, caption = "Geodatabase musym missing from the legend")

write.csv(qa, paste0("C:/workspace/report_spatial_qa_", SS_Office, "_", format(Sys.time(), "%Y_%m_%d"), ".csv"))

# id <- match(nasis_qa2$key, geo_qa2$key, incomparables=TRUE)
# nasis_mis <- unique(nasis_qa2$key[is.na(id)]) # key present in NASIS, but missing from the geodatabase
# length(nasis_mis); print("number of musym missing from the RTSD geodatabase")

# id <- match(geo_qa2$key, nasis_qa2$key, incomparables=TRUE)
# geo_mis <- unique(geo_qa2$key[is.na(id)]) # key present in the geodatabase, but missing from NASIS
# length(geo_mis); print("number of musym missing from NASIS")

```
```{r, adjacent regions, echo=FALSE}
outside <- merge(region, qa, by = "AREASYMBOL")
outside$key <- with(outside, paste0(AREASYMBOL, "_", musym))
outside <- subset(outside, Region != R_Office & match == FALSE, select = c("Region", "AREASYMBOL", "pname", "musym", "old_musym", "n_polygons", "acres", "key", "in_legend"))
kable(outside, caption = "MUSYM that need updating outside of Region")

```