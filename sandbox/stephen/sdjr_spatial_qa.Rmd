# Report of changes requiring SSURGO recertification

```{r, echo=FALSE, warning=FALSE}
# These figures don't compare with Alena's spreadsheets. Her spreadsheets have additional counties that aren't captured in the Project Record.
# This assumes no changes have been made to the ORIG columns, could run Alena's qa against an unedited copy.

options(stringsAsFactors = F)

library(foreign)
library(knitr)
library(plyr)
library(RCurl)
library(XML)

source("C:/workspace/github/soil-pit/trunk/queries/kssl_queries.R")

fy <- 2016
region <- 11
office <- "11-CLI"
mupolygon <- read.dbf("M:/geodata/project_data/11CLI/11CLIedits.dbf", as.is = TRUE)
owners <- read.csv("M:/geodata/soils/SSA_Regional_Ownership_MASTER_MLRA_OFFICE.csv")

# data(state)
# st <- paste0(tolower(state.abb), "%25")
st <- paste0(toupper(c("ia", "il", "in", "ks", "ky", "mi", "mn", "mo", "ne", "oh", "ok", "sd", "wi")), "%25")

# goals <- goals_report(fy, paste0(region, "-%25"))
goals <- read.csv("C:/workspace/report_goals_fy16_2016_08_31.csv")

# corr <- sdjr_correlation(asymbol, project_id, start_date, finish_date)
corr <- read.csv("C:/workspace/report_correlation_fy2016_AK%25_WY%25_2016_08_31.csv")

# legend <- legends_report(st)
legends <- read.csv("C:/workspace/report_legends_2016_08_31.csv")
```

```{r, summarize geodatabase tabular changes, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

# WEB-MLRA_Goals_Progress

goals_sub <- goals[goals$ss_office == office, ]
goals_summary <- ddply(goals_sub, .(ss_office), summarize,
  n_projects = length(unique(project_name)),
  goaled = sum(goaled), 
  claimed = sum(reported),
  progress = goaled / claimed * 100
  )

kable(goals_summary, caption = "Number or SDJR projects per SS Office")


# Correlation report (completed spatial changes in NASIS)

corr_sub <- corr[corr$office %in% office & !is.na(corr$new_musym), ]
corr_summary <- ddply(corr_sub, .(office), summarize,
                      n_projects = length(unique(projectiid)),
                      acres = sum(muacres) * 0.2
                      )
kable(corr_summary, caption = "Number of completed spatial changes")

vars <- c("office", "projectname", "areasymbol", "new_musym")
nasis_qa <- ddply(corr_sub, vars, summarize, 
                  n_musym = length(unique(musym)),
                  musym2 = paste0(unique(musym), collapse=", ")
                  )

nasis_qa2 <- ddply(nasis_qa, c(vars, "new_musym", "n_musym"), summarize,
                   musym = strsplit(musym2, ", ")[[1]]
                   )


# Geodatabase report (completed spatial changes in geodatabase)

idx <- names(mupolygon) %in% c("MUSYM", "ORIG_MUSYM", "Editor_Fie")
names(mupolygon)[idx] <- c("new_musym", "musym", "editor")
names(mupolygon) <- tolower(names(mupolygon))

idx <- with(mupolygon, (musym != new_musym & musym != "") | editor != "")
mupolygon_edits <- mupolygon[idx, ]

vars <- c("areasymbol", "new_musym")
geo_qa <- ddply(mupolygon_edits, vars, summarise,
                n_polygons = length(musym),
                acres = round(sum(shape_area*0.000247), 0),
                n_musym = length(unique(musym)),
                musym2 = paste0(unique(musym), collapse=", ")
                )

geo_qa2 <- ddply(geo_qa, c(vars, "n_polygons", "acres", "n_musym", "musym2"), summarize,
                 musym = strsplit(musym2, ", ")[[1]]
                 )


write.csv(geo_qa2, 
          paste0(
            "C:/workspace/report_spatial_geo_qa_", 
            office, 
            "_", 
            format(Sys.time(), "%Y_%m_%d"), 
            ".csv"), 
          row.names = FALSE)
```

```{r, QA checks, echo=FALSE}
# QA checks
vars <- c("areasymbol", "new_musym", "musym")
qa <- merge(nasis_qa2, geo_qa2, by = vars, all = TRUE) # match geo_qa2 to nasis_qa2
# qa2 <- join(nasis_qa2, geo_qa2, by = key, type = "full") # match geo_qa2 to nasis_qa2

leg_key <- with(legends, paste0(mapunit_symbol, "_", area_symbol))
qa_key <- with(qa, paste0(new_musym, "_", areasymbol))

qa <- transform(qa, 
                in_legend = qa_key %in% leg_key,
                in_project = !is.na(projectname),
                in_geodatabase = is.na(n_polygons)
                )

qa0 <- subset(qa, new_musym != musym & apply(is.na(qa), 1, any)) # remove where musym = old musym

qa1 <- qa0[qa0$in_project == TRUE, ]
qa2 <- qa0[qa0$in_geodatabase == TRUE, ]
qa3 <- qa0[qa0$in_legend == FALSE, ]

kable(qa1, caption = "NASIS changes missing from the geodatabase")
print("Missing values (NA) need to be either added/removed from NASIS or the RTSD geodatabase, Otherwise they maybe splits that need to be relinked to a new additional mapunit.")

kable(qa2, caption = "Geodatabase changes missing from NASIS")
print("Missing values (NA) need to be either added/removed from NASIS or the RTSD geodatabase, Otherwise they maybe splits that need to be relinked to a new additional mapunit.")

kable(qa3, caption = "Geodatabase musym missing from the legend")

write.csv(qa, paste0("C:/workspace/report_spatial_qa_", office, "_", format(Sys.time(), "%Y_%m_%d"), ".csv"))

# id <- match(nasis_qa2$key, geo_qa2$key, incomparables=TRUE)
# nasis_mis <- unique(nasis_qa2$key[is.na(id)]) # key present in NASIS, but missing from the geodatabase
# length(nasis_mis); print("number of musym missing from the RTSD geodatabase")

# id <- match(geo_qa2$key, nasis_qa2$key, incomparables=TRUE)
# geo_mis <- unique(geo_qa2$key[is.na(id)]) # key present in the geodatabase, but missing from NASIS
# length(geo_mis); print("number of musym missing from NASIS")

```
```{r, adjacent regions, echo=FALSE}
outside <- merge(qa, owners, by.x = "areasymbol", by.y = "AREASYMBOL", sort = FALSE, all.x = TRUE)
outside$key <- with(outside, paste0(areasymbol, "_", musym))
outside <- subset(outside, outside$office %in% office & new_musym != musym, 
                  select = c(office, areasymbol, projectname, new_musym, musym, n_polygons, acres, key, in_legend))

kable(outside, caption = "MUSYM that need updating outside of Region")

```