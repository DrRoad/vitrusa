# set options and load packages
options(stringsAsFactors = FALSE)

library(foreign)
library(rgdal)
library(XML)
library(RCurl)
library(dplyr)
library(lattice)
library(latticeExtra)
library(ggplot2)
library(RColorBrewer)

source("C:/workspace/github/soil-pit/trunk/queries/kssl_queries.R")

years <- 2012:2016

goals <- lapply(years, function(x) goals_report(x, "%25"))


# WEB-PROJECT-Counties+with+approved+projects+DU
fy <- 2015

du2015 <- du_report(2015)
# du <- read.csv("report_digiting_unit_2015_08_11.csv")

du11 <- subset(du, State_Responsible == "Indiana")

ddply(du11, .(Office), summarize, nProjects = length(unique(Project_Name)))
```


```{r correlation report, echo=FALSE}
# WEB-Correlation_state_fy_ids

# all states
data(state)
st <- tolower(state.abb)
asymbol <- paste0(st, "%25")

# region 11 states
ssa <- readOGR(dsn = "M:/geodata/soils/soilsa_a_nrcs.shp", layer = "soilsa_a_nrcs", encoding = "ESRI Shapefile")@data
ssa$st <- substr(ssa$areasymbol, 1, 2)
st <- toupper(c("ia", "il", "in", "ks", "ky", "mi", "mn", "mo", "ne", "oh", "ok", "sd", "wi"))
asymbol <-  sort(ssa[ssa$st %in% st, "areasymbol"])

report <- lapply(years, function(x) sdjr_correlation(asymbol, x, "10/01/2015", "10/01/2016"))

# corr <- read.csv("report_correlation_2015_09_02_spatial.csv")
# corr$region <- unlist(lapply(corr$Office, function(x) strsplit(x, "-")[[1]][1]))

corr11 <- subset(corr, grepl("11-", Office))
corr11 <- rename(corr11, c("Project_Name" = "pname", "New_Symbol" = "musym_corr", "Old_Musym2" = "old_musym_corr"))

ddply(corr11, .(Office), summarize, nProjects = length(unique(pname)))



# WEB-spatial_asym_uprojectid_dates

data(state)
# st <- tolower(state.abb)
ssa <- read.dbf("M:/geodata/soils/soilsa_a_nrcs.dbf")
st <- sort(unique(substr(ssa$areasymbol, 1, 2)))
# st <- paste0(c("in", "oh")) # Region 11
asymbol <- paste0(st, "%25")
start_date <- "10/01/2015"
finish_date <- "09/30/2016"
project_id <- "%25"

test <- sdjr_correlation(asymbol, project_id, start_date, finish_date)

# Need to find a way to weight this on the size of the Region
sdjr_us <- group_by(test, region) %>% filter(projecttypename == "SDJR" & fy == "2016") %>% summarize(
  n_projects       = length(unique(projectiid)),
  n_musym          = length(unique(musym)),
  n_asymbol        = length(unique(areasymbol)),
  n_spatial        = sum(spatial_change, na.rm = T),
  approved_acres   = round(sum(muacres, na.rm = TRUE)),
  correlated_acres = round(sum(new_muacres, na.rm = TRUE)),
  pct_finished     = round((correlated_acres / approved_acres) * 100)) %>% 
  arrange(desc(correlated_acres))

dotplot(correlated_acres ~ region, data = sdjr_us)


sdjr_region11 <- group_by(test, office) %>% filter(region == "11" & projecttypename == "SDJR" & fy == "2016") %>% summarize(
  n_projects       = length(unique(projectiid)),
  n_musym          = length(unique(musym)),
  n_asymbol        = length(unique(areasymbol)),
  n_spatial        = sum(spatial_change, na.rm = T),
  approved_acres   = round(sum(muacres, na.rm = TRUE)),
  correlated_acres = round(sum(new_muacres, na.rm = TRUE)),
  pct_finished     = round((correlated_acres / approved_acres) * 100)) %>% 
  arrange(office)

sdjr_region11
ggplot(sdjr_region11, aes(x = pct_finished, y = correlated_acres, color = office)) + geom_point(cex = 5) + scale_colour_brewer(palette="RdYlBu")


sdjr_region11 <- as.data.frame(sdjr_region11)
opar <- trellis.par.get()
trellis.par.set(ggplot2like())
oopt <- lattice.options(ggplot2like.opts())

color <- brewer.pal(104, "RdYlBu")
xyplot(correlated_acres ~ pct_finished, groups = office, data = sdjr_region11,
       type = c("p", "g"), cex = 2, pch = 16, col = color,  
       key = list(text = list(sdjr_region11$office), space = "right", 
                  points = list(pch = 16, col = color, cex = 2))
       )


r11_spatial <- group_by(test, region, office) %>%
filter(projecttypename == "SDJR" & region == 11 & spatial_change == TRUE) %>% 
summarize(
  acres = sum(muacres, na.rm = T),
  n_areasymbol = length(unique(areasymbol))
  ) %>%
arrange(desc(acres))

ggplot(r11_spatial, aes(x = n_areasymbol, y = acres, color = office)) + geom_point(cex = 5) + scale_colour_brewer(palette="RdYlBu") + scale_y_continuous()


st <- paste0(toupper(c("ia", "il", "in", "ks", "ky", "mi", "mn", "mo", "ne", "oh", "ok", "sd", "wi")), "%25")
leg <- legends_report(st)

```



